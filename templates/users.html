{% extends "base.html" %} {% block title %}Foydalanuvchilar - Buyurtmalar
Boshqaruvi{% endblock %} {% block content %}

<!-- Compact Quick Stats Section -->
{% if users %}
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header py-2">
        <h6 class="mb-0">
          <i class="fas fa-chart-simple me-2"></i>
          Foydalanuvchi Statistikasi
        </h6>
      </div>
      <div class="card-body py-3">
        <div class="row text-center g-2">
          <div class="col-3 col-md-3">
            <div
              class="p-2 rounded-2"
              style="background-color: var(--primary-100)"
            >
              <div class="h5 fw-bold text-primary mb-1">{{ users|length }}</div>
              <small class="text-muted d-none d-md-block"
                >Jami Foydalanuvchilar</small
              >
              <small class="text-muted d-md-none" style="font-size: 0.65rem"
                >Jami</small
              >
            </div>
          </div>
          <div class="col-3 col-md-3">
            <div
              class="p-2 rounded-2"
              style="background-color: var(--success-100)"
            >
              <div class="h5 fw-bold text-success mb-1">
                {{ users|selectattr("reg_step", "equalto", "done")|list|length
                }}
              </div>
              <small class="text-muted d-none d-md-block"
                >Ro'yxatdan O'tgan</small
              >
              <small class="text-muted d-md-none" style="font-size: 0.65rem"
                >Ro'yxat</small
              >
            </div>
          </div>
          <div class="col-3 col-md-3">
            <div
              class="p-2 rounded-2"
              style="background-color: var(--warning-100)"
            >
              <div class="h5 fw-bold text-warning mb-1">
                {{ users|rejectattr("reg_step", "equalto", "done")|list|length
                }}
              </div>
              <small class="text-muted d-none d-md-block">Tugallanmagan</small>
              <small class="text-muted d-md-none" style="font-size: 0.65rem"
                >Tugall.</small
              >
            </div>
          </div>
          <div class="col-3 col-md-3">
            <div
              class="p-2 rounded-2"
              style="background-color: var(--info-100)"
            >
              <div class="h5 fw-bold text-info mb-1">
                {{ users|sum(attribute='order_count') or 0 }}
              </div>
              <small class="text-muted d-none d-md-block"
                >Jami Buyurtmalar</small
              >
              <small class="text-muted d-md-none" style="font-size: 0.65rem"
                >Buy-lar</small
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Users Header -->
<div class="card mb-3">
  <div class="card-body p-3">
    <!-- Title Section -->
    <div class="d-flex align-items-center gap-2 mb-3">
      <div class="p-2 bg-primary rounded">
        <i class="fas fa-user text-white fs-5"></i>
      </div>
      <div>
        <h4 class="mb-0 fw-semibold">Foydalanuvchilar</h4>
        <p class="text-muted mb-0 small d-none d-md-block">
          Foydalanuvchilar boshqaruvi
        </p>
      </div>
    </div>

    <!-- Filters Section - Desktop -->
    <div class="d-none d-md-flex align-items-center gap-3">
      <!-- Search Filter -->
      <div class="d-flex align-items-center gap-2">
        <label for="searchUsers" class="form-label mb-0 text-muted small">
          <i class="fas fa-magnifying-glass me-1"></i>Qidirish:
        </label>
        <input
          type="text"
          id="searchUsers"
          class="form-control form-control-sm"
          style="width: 200px"
          placeholder="Ism, telefon, username..."
          onkeyup="filterUsers()"
        />
      </div>
      <!-- Status Filter -->
      <div class="d-flex align-items-center gap-2">
        <label for="statusFilter" class="form-label mb-0 text-muted small">
          <i class="fas fa-filter me-1"></i>Status:
        </label>
        <select
          id="statusFilter"
          class="form-select form-select-sm"
          style="width: 140px"
          onchange="filterUsers()"
        >
          <option value="">Barcha Foydalanuvchilar</option>
          <option value="done">Ro'yxatdan O'tgan</option>
          <option value="incomplete">Tugallanmagan</option>
          <option value="active">Faol</option>
          <option value="inactive">Faol Emas</option>
        </select>
      </div>
      <!-- Clear Filters -->
      <button
        class="btn btn-outline-secondary btn-sm"
        onclick="clearUserFilters()"
        title="Barcha filtrlarni tozalash"
      >
        <i class="fas fa-xmark"></i>
      </button>
    </div>

    <!-- Filters Section - Mobile -->
    <div class="d-md-none">
      <div class="row g-2">
        <div class="col-8">
          <input
            type="text"
            id="searchUsersMobile"
            class="form-control form-control-sm"
            placeholder="Qidirish..."
            onkeyup="filterUsersMobile()"
          />
        </div>
        <div class="col-4">
          <select
            id="statusFilterMobile"
            class="form-select form-select-sm"
            onchange="filterUsersMobile()"
          >
            <option value="">Barchasi</option>
            <option value="done">Ro'yxat</option>
            <option value="incomplete">Tugall.</option>
            <option value="active">Faol</option>
            <option value="inactive">NoFaol</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <button
          class="btn btn-outline-secondary btn-sm w-100"
          onclick="clearUserFiltersMobile()"
        >
          <i class="fas fa-arrow-rotate-right me-1"></i>
          Tozalash
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Total Count Display -->
<div class="mb-3">
  <div class="badge bg-primary fs-6">{{ users|length }} ta jami</div>
</div>

{% if users %}
<div class="row" id="usersContainer">
  {% for user in users %}
  <div
    class="col-sm-6 col-lg-6 col-xl-4 mb-4 user-item"
    data-search="{{ (user.name or '') + ' ' + (user.surname or '') + ' ' + (user.phone or '') + ' ' + (user.username or '') }}"
    data-reg-step="{{ user.reg_step }}"
    data-active="{{ 'true' if user.is_active else 'false' }}"
  >
    <div class="card h-100">
      <div class="card-body">
        <!-- User Avatar and Basic Info -->
        <div class="d-flex align-items-center mb-3">
          <div class="me-3">
            <div
              class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
              style="width: 60px; height: 60px"
            >
              <i class="fas fa-user fa-lg"></i>
            </div>
          </div>
          <div class="flex-grow-1">
            <h5 class="mb-1">
              {{ user.name or 'N/A' }} {{ user.surname or '' }}
            </h5>
            <div class="text-muted mb-1">
              <i class="fas fa-id-badge me-1"></i>
              ID: {{ user.telegram_id or 'N/A' }}
            </div>
            {% if user.user_code or (user.collection_id and user.code) %}
            <div class="text-muted mb-1">
              <i class="fas fa-qrcode me-1"></i>
              Kod: {{ user.user_code or (user.collection_id ~ '-' ~ user.code) if user.code else 'N/A' }}
            </div>
            {% endif %}
            {% if user.username %}
            <div class="text-muted">
              <i class="fas fa-at me-1"></i>
              @{{ user.username }}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Contact Info -->
        <div class="mb-3">
          <div class="text-muted mb-1">
            <i class="fas fa-phone me-1"></i>
            {{ user.phone or 'Telefon yo\'q' }}
          </div>
        </div>

        <!-- Status Badges -->
        <div class="d-flex flex-wrap gap-2 mb-3">
          <span class="badge bg-{{ user.reg_status_class }}">
            {{ user.reg_status_icon }} {{ user.reg_status }}
          </span>
          <span class="badge bg-{{ user.active_status_class }}">
            {{ user.active_status_icon }} {{ user.active_status }}
          </span>
        </div>

        <!-- Statistics -->
        <div class="row text-center mb-3">
          <div class="col-4">
            <div class="fw-bold text-success fs-5">
              {{ user.order_count or 0 }}
            </div>
            <small class="text-muted">Buyurtmalar</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-info fs-5">
              {{ user.collections_count or 0 }}
            </div>
            <small class="text-muted">Kolleksiyalar</small>
          </div>
          <div class="col-4">
            <div class="fw-bold text-primary fs-5">
              {% if user.latest_order_id %} #{{ user.latest_order_id }} {% else
              %} - {% endif %}
            </div>
            <small class="text-muted">So'nggi</small>
          </div>
        </div>

        <!-- Latest Order Date -->
        {% if user.latest_order_formatted != 'No orders' %}
        <div class="text-center mb-3">
          <small class="text-muted">
            <i class="fas fa-clock me-1"></i>
            So'nggi Buyurtma: {{ user.latest_order_formatted }}
          </small>
        </div>
        {% endif %}

        <!-- Action Button -->
        <div class="d-grid">
          <div class="btn-group">
            <button
              class="btn btn-outline-primary btn-sm"
              data-user-id="{{ user.id }}"
              data-user-name="{{ user.name or '' | e }}"
              data-user-surname="{{ user.surname or '' | e }}"
              data-user-phone="{{ user.phone or '' | e }}"
              onclick="openEditModal(this.dataset.userId, this.dataset.userName, this.dataset.userSurname, this.dataset.userPhone)"
            >
              <i class="fas fa-edit me-1"></i> Tahrirlash
            </button>
            <form
              action="/users/{{ user.id }}/toggle_active"
              method="post"
              class="d-inline"
            >
              {% if user.is_active %}
              <button
                type="submit"
                class="btn btn-outline-danger btn-sm"
                onclick="event.preventDefault(); customConfirm('Haqiqatan ham bu foydalanuvchini bloklamoqchimisiz?', (confirmed) => { if (confirmed) this.form.submit(); });"
              >
                <i class="fas fa-ban me-1"></i> Bloklash
              </button>
              {% else %}
              <button
                type="submit"
                class="btn btn-outline-success btn-sm"
                onclick="event.preventDefault(); customConfirm('Haqiqatan ham bu foydalanuvchini blokdan chiqarmoqchimisiz?', (confirmed) => { if (confirmed) this.form.submit(); });"
              >
                <i class="fas fa-check-circle me-1"></i> Blokdan Chiqarish
              </button>
              {% endif %}
            </form>
            {% if user.order_count and user.order_count > 0 %}
            <button
              class="btn btn-outline-info btn-sm"
              data-user-code="{{ user.user_code or (user.collection_id ~ '-' ~ user.code) if user.code else '' }}"
              onclick="(function(btn){
                var code = btn.dataset.userCode || '';
                if(code){ try{ localStorage.setItem('orders_code_prefill', code); }catch(e){} window.location.href='/orders'; }
                else { window.location.href='/orders'; }
              })(this)"
            >
              <i class="fas fa-list"></i>
            </button>
            {% else %}
            <button class="btn btn-outline-secondary btn-sm" disabled>
              <i class="fas fa-list"></i>
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- No Results Message (hidden by default) -->
<div id="noUsersMessage" class="text-center py-5" style="display: none">
  <div class="display-1 text-muted mb-3">
    <i class="fas fa-magnifying-glass"></i>
  </div>
  <h3 class="text-muted">Filtrlaringizga Mos Foydalanuvchi Topilmadi</h3>
  <p class="text-muted">
    Qidiruv mezonlaringizni yoki filtrlaringizni o'zgartirib ko'ring.
  </p>
  <button class="btn btn-primary" onclick="clearUserFilters()">
    <i class="fas fa-arrow-rotate-right me-2"></i>
    Filtrlarni Tozalash
  </button>
</div>

{% else %}
<div class="text-center py-5">
  <div class="display-1 text-muted mb-3">
    <i class="fas fa-user-slash"></i>
  </div>
  <h3 class="text-muted">Foydalanuvchilar Topilmadi</h3>
  <p class="text-muted">Hali hech qanday foydalanuvchi ro'yxatdan o'tmagan.</p>
</div>
{% endif %}

<!-- Edit User Modal -->
<div
  class="modal fade"
  id="editUserModal"
  tabindex="-1"
  aria-labelledby="editUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">
          Foydalanuvchini Tahrirlash
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Yopish"
        ></button>
      </div>
      <form id="editUserForm" method="post">
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_user_name" class="form-label">Ism</label>
            <input
              type="text"
              class="form-control"
              id="edit_user_name"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit_user_surname" class="form-label">Familiya</label>
            <input
              type="text"
              class="form-control"
              id="edit_user_surname"
              name="surname"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit_user_phone" class="form-label">Telefon</label>
            <input
              type="text"
              class="form-control"
              id="edit_user_phone"
              name="phone"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Bekor qilish
          </button>
          <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  let editUserModal;

  document.addEventListener("DOMContentLoaded", function () {
    editUserModal = new bootstrap.Modal(
      document.getElementById("editUserModal")
    );
  });

  function openEditModal(userId, name, surname, phone) {
    const form = document.getElementById("editUserForm");
    form.action = `/users/${userId}/edit`;
    document.getElementById("edit_user_name").value = name;
    document.getElementById("edit_user_surname").value = surname;
    document.getElementById("edit_user_phone").value = phone;
    editUserModal.show();
  }

  function filterUsers() {
    const searchTerm = document
      .getElementById("searchUsers")
      .value.toLowerCase();
    const statusFilter = document.getElementById("statusFilter").value;
    performUserFilter(searchTerm, statusFilter);
  }

  function filterUsersMobile() {
    const searchTerm = document
      .getElementById("searchUsersMobile")
      .value.toLowerCase();
    const statusFilter = document.getElementById("statusFilterMobile").value;

    // Sync with desktop controls
    document.getElementById("searchUsers").value = searchTerm;
    document.getElementById("statusFilter").value = statusFilter;

    performUserFilter(searchTerm, statusFilter);
  }

  function performUserFilter(searchTerm, statusFilter) {
    let items = Array.from(document.querySelectorAll(".user-item"));

    // Filter by search term
    if (searchTerm) {
      items = items.filter((item) => {
        const searchData = item.getAttribute("data-search").toLowerCase();
        return searchData.includes(searchTerm);
      });
    }

    // Filter by status
    if (statusFilter) {
      items = items.filter((item) => {
        const regStep = item.getAttribute("data-reg-step");
        const isActive = item.getAttribute("data-active") === "true";

        switch (statusFilter) {
          case "done":
            return regStep === "done";
          case "incomplete":
            return regStep !== "done";
          case "active":
            return isActive;
          case "inactive":
            return !isActive;
          default:
            return true;
        }
      });
    }

    // Hide all items first
    document.querySelectorAll(".user-item").forEach((item) => {
      item.style.display = "none";
    });

    // Show filtered items
    items.forEach((item) => {
      item.style.display = "block";
    });

    // Update count and show/hide no results message
    updateUserFilteredCount(items.length);
  }

  function clearUserFilters() {
    // Clear search
    document.getElementById("searchUsers").value = "";
    document.getElementById("searchUsersMobile").value = "";

    // Clear status filter
    document.getElementById("statusFilter").value = "";
    document.getElementById("statusFilterMobile").value = "";

    // Show all items
    document.querySelectorAll(".user-item").forEach((item) => {
      item.style.display = "block";
    });

    // Update count
    const totalItems = document.querySelectorAll(".user-item").length;
    updateUserFilteredCount(totalItems);
  }

  function clearUserFiltersMobile() {
    clearUserFilters();
  }

  function updateUserFilteredCount(count) {
    const noResultsMessage = document.getElementById("noUsersMessage");
    const usersContainer = document.getElementById("usersContainer");

    if (count === 0) {
      noResultsMessage.style.display = "block";
      if (usersContainer) usersContainer.style.display = "none";
    } else {
      noResultsMessage.style.display = "none";
      if (usersContainer) usersContainer.style.display = "";
    }
  }
</script>
{% endblock %}
