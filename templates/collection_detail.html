{% extends "base.html" %} {% block title %}Kolleksiya #{{ collection.id }} -
Buyurtmalar Boshqaruvi{% endblock %} {% block head %}
<style>
  @keyframes pulse-green-bg {
    0%,
    100% {
      box-shadow: -2px 0 20px rgba(16, 185, 129, 0.5),
        -4px 0 40px rgba(16, 185, 129, 0.3);
      opacity: 1;
    }
    50% {
      box-shadow: -2px 0 30px rgba(16, 185, 129, 0.7),
        -4px 0 60px rgba(16, 185, 129, 0.5);
      opacity: 0.9;
    }
  }
</style>
{% endblock %} {% block content %}

<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Boshqaruv Paneli</a></li>
    <li class="breadcrumb-item"><a href="/collections">Kolleksiyalar</a></li>
    <li class="breadcrumb-item active" aria-current="page">
      Kolleksiya #{{ collection.id }}
    </li>
  </ol>
</nav>

<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-1 fw-bold">Kolleksiya #{{ collection.id }}</h2>
        <span class="badge bg-{{ collection.status_class }}"
          >{{ collection.status_icon }} {{ collection.status_text }}</span
        >
        <small class="text-muted ms-2">
          <i class="fas fa-calendar-plus me-1"></i>
          Yaratilgan: {{ collection.created_at[:10] }}
        </small>
      </div>
      <div>
        {% if collection.status == 'finish' %}
        <button
          class="btn btn-dark btn-lg shadow-sm"
          onclick="openMultipleReportsModal({{ collection.id }})"
          style="
            background: #2c3e50;
            border: none;
            border-radius: 15px;
            padding: 12px 28px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
          "
          onmouseover="this.style.transform='translateY(-2px)'; this.style.backgroundColor='#34495e'; this.style.boxShadow='0 6px 20px rgba(44, 62, 80, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.backgroundColor='#2c3e50'; this.style.boxShadow='0 4px 15px rgba(44, 62, 80, 0.3)'"
        >
          <i class="fas fa-paper-plane me-2"></i>
          Hisobotlar Yuborish
        </button>
        {% else %}
        <div class="d-flex flex-column align-items-end">
          <button
            class="btn btn-secondary btn-lg shadow-sm"
            disabled
            style="
              background: #6c757d;
              border: none;
              border-radius: 15px;
              padding: 12px 28px;
              font-weight: 600;
              letter-spacing: 0.5px;
              opacity: 0.6;
              cursor: not-allowed;
            "
            title="Hisobotlar faqat tugallangan kolleksiyalarga yuboriladi"
          >
            <i class="fas fa-lock me-2"></i>
            Hisobotlar Yuborish
          </button>
          <small class="text-muted mt-1" style="font-size: 0.75rem">
            <i class="fas fa-info-circle me-1"></i>
            Kolleksiya tugallanganda mavjud bo'ladi
          </small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body text-center">
        <i class="fas fa-shopping-cart fa-2x text-primary mb-2"></i>
        <h4 class="fw-bold mb-1">{{ collection.total_orders }}</h4>
        <p class="text-muted mb-0">Jami Buyurtmalar</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body text-center">
        <i class="fas fa-users fa-2x text-success mb-2"></i>
        <h4 class="fw-bold mb-1">{{ collection.unique_users }}</h4>
        <p class="text-muted mb-0">Unikal Foydalanuvchilar</p>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Users and Orders Section -->
<div class="users-list-container">
  {% for user in users %}
  <div
    class="user-card-enhanced card mb-4 shadow-sm border-0"
    style="position: relative"
  >
    <!-- Report Status Indicator Light -->
    {% if user.has_report %}
    <div
      id="report-indicator-{{ user.id }}"
      style="
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 8px;
        background: linear-gradient(135deg, #10b981, #059669);
        box-shadow: -2px 0 20px rgba(16, 185, 129, 0.5),
          -4px 0 40px rgba(16, 185, 129, 0.3);
        border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
        z-index: 5;
        animation: pulse-green-bg 2s ease-in-out infinite;
      "
      title="Hisobot yuborilgan"
    ></div>
    {% else %}
    <div id="report-indicator-{{ user.id }}" style="display: none"></div>
    {% endif %}

    <!-- User Header -->
    <div
      class="user-header p-4 cursor-pointer"
      onclick="toggleUserOrders('{{ user.id }}')"
      style="
        background: linear-gradient(
          135deg,
          var(--bg-secondary) 0%,
          var(--bg-tertiary) 100%
        );
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      "
    >
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <!-- User Avatar -->
          <div class="user-avatar me-3">
            <div
              class="avatar-circle d-flex align-items-center justify-content-center"
              style="
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: linear-gradient(
                  135deg,
                  var(--primary-500),
                  var(--primary-600)
                );
                color: white;
                font-size: 1.2rem;
                font-weight: 600;
              "
            >
              {{ (user.name or 'U')[0]|upper }}
            </div>
          </div>

          <!-- User Info -->
          <div class="user-info">
            <div class="user-name-section">
              <div class="d-flex align-items-center gap-2 mb-1">
                <h5 class="mb-0 fw-bold text-primary">
                  {{ user.name or 'N/A' }} {{ user.surname or '' }}
                </h5>
                {% if user.code %}
                <span
                  class="badge bg-gradient px-3 py-2"
                  style="
                    background: linear-gradient(
                      135deg,
                      #667eea 0%,
                      #764ba2 100%
                    );
                    font-size: 0.85rem;
                    font-weight: 600;
                  "
                >
                  <i class="fas fa-hashtag me-1"></i>{{ collection.id }}-{{
                  user.code }}
                </span>
                {% endif %}
              </div>
              <div class="user-meta d-flex align-items-center flex-wrap gap-3">
                {% if user.username %}
                <span class="text-muted small">
                  <i class="fab fa-telegram-plane me-1"></i>@{{ user.username }}
                </span>
                {% endif %} {% if user.phone %}
                <span class="text-muted small">
                  <i class="fas fa-phone me-1"></i>{{ user.phone }}
                </span>
                {% endif %} {% if user.region %}
                <span class="text-muted small">
                  <i class="fas fa-map-marker-alt me-1"></i>{{ user.region }}
                </span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Right side info -->
        <div class="user-stats d-flex align-items-center">
          <div class="text-end me-3">
            <div class="badge bg-primary px-3 py-2" style="font-size: 0.9rem">
              <i class="fas fa-shopping-bag me-1"></i>
              {{ user.order_count }} buyurtma
            </div>
            {% if user.telegram_id %}
            <div class="text-muted small mt-1">ID: {{ user.telegram_id }}</div>
            {% endif %}
          </div>
          {% if collection.status == 'finish' %}
          <button
            id="report-button-{{ user.id }}"
            class="btn btn-secondary me-3"
            onclick="event.stopPropagation(); openSingleReportModal({{ user.id }}, '{{ user.name or 'User' }}', {{ collection.id }}, {{ 'true' if user.has_report else 'false' }});"
            style="
              background: #495057;
              border: none;
              border-radius: 12px;
              padding: 8px 16px;
              font-weight: 500;
              color: white;
              font-size: 0.85rem;
              transition: all 0.3s ease;
              box-shadow: 0 3px 10px rgba(73, 80, 87, 0.3);
            "
            onmouseover="this.style.transform='translateY(-1px)'; this.style.backgroundColor='#5a6268'; this.style.boxShadow='0 4px 15px rgba(73, 80, 87, 0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.backgroundColor='#495057'; this.style.boxShadow='0 3px 10px rgba(73, 80, 87, 0.3)'"
          >
            {% if user.has_report %}
            <i class="fas fa-sync me-1"></i>Hisobotni Yangilash {% else %}
            <i class="fas fa-file-pdf me-1"></i>Hisobotni Yuborish {% endif %}
          </button>
          {% else %}
          <button
            class="btn btn-outline-secondary me-3"
            disabled
            style="
              border: 1px solid #6c757d;
              border-radius: 12px;
              padding: 8px 16px;
              font-weight: 500;
              color: #6c757d;
              font-size: 0.85rem;
              opacity: 0.6;
              cursor: not-allowed;
            "
            title="Hisobotlar faqat tugallangan kolleksiyalarga yuboriladi"
          >
            <i class="fas fa-lock me-1"></i>
            Hisobot
          </button>
          {% endif %}
          <i
            class="fas fa-chevron-down transition-all"
            id="chevron-{{ user.id }}"
            style="
              color: var(--text-secondary);
              transition: transform 0.3s ease;
            "
          ></i>
        </div>
      </div>
    </div>

    <!-- User Orders (Collapsible) -->
    <div
      class="user-orders-container"
      id="orders-container-{{ user.id }}"
      style="display: none"
    >
      <div
        class="orders-header px-4 py-3 border-top border-bottom"
        style="background: var(--bg-primary)"
      >
        <h6 class="mb-0 text-secondary fw-semibold">
          <i class="fas fa-list-ul me-2"></i>
          Buyurtmalar ({{ user.order_count }})
        </h6>
      </div>
      <div class="orders-grid p-4">
        <div class="row g-4">
          {% for order in user.orders %}
          <div class="col-md-6 col-xl-4">
            <div
              class="order-card-enhanced card border-0 shadow-sm h-100"
              style="
                cursor: pointer;
                transition: all 0.3s ease;
                border-radius: var(--radius-lg);
                overflow: hidden;
              "
              onclick="viewOrderDetails({{ order.id }})"
              onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-md)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'"
            >
              <!-- Order Image -->
              <div
                class="order-image-container position-relative"
                style="height: 200px; overflow: hidden"
              >
                {% if order.display_image_url %}
                <img
                  src="/{{ order.display_image_url }}"
                  class="card-img-top"
                  alt="Order image"
                  style="
                    height: 100%;
                    width: 100%;
                    object-fit: cover;
                    transition: transform 0.3s ease;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                />
                <div
                  class="image-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                  style="
                    background: rgba(0, 0, 0, 0.4);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                  "
                >
                  <i class="fas fa-eye text-white fa-2x"></i>
                </div>
                {% else %}
                <div
                  class="d-flex align-items-center justify-content-center h-100"
                  style="
                    background: linear-gradient(
                      135deg,
                      var(--neutral-100),
                      var(--neutral-200)
                    );
                    color: var(--text-tertiary);
                  "
                >
                  <div class="text-center">
                    <i class="fas fa-image fa-3x mb-2"></i>
                    <div class="small">Rasm yo'q</div>
                  </div>
                </div>
                {% endif %}

                <!-- Order ID Badge -->
                <div class="position-absolute top-0 start-0 m-3">
                  <span
                    class="badge px-3 py-2"
                    style="
                      background: rgba(var(--primary-600), 0.9);
                      backdrop-filter: blur(10px);
                      border-radius: var(--radius-md);
                      font-size: 0.8rem;
                    "
                  >
                    #{{ order.id }}
                  </span>
                </div>

                <!-- File Count Badge -->
                {% if order.file_count and order.file_count > 0 %}
                <div class="position-absolute top-0 end-0 m-3">
                  <span
                    class="badge px-2 py-1"
                    style="
                      background: rgba(var(--info-600), 0.9);
                      backdrop-filter: blur(10px);
                      border-radius: var(--radius-sm);
                      font-size: 0.75rem;
                    "
                  >
                    <i class="fas fa-paperclip me-1"></i>{{ order.file_count }}
                  </span>
                </div>
                {% endif %}
              </div>

              <!-- Order Content -->
              <div class="card-body p-4">
                <div class="order-header mb-3">
                  <h6 class="card-title mb-2 fw-bold text-primary">
                    Buyurtma #{{ order.id }}
                  </h6>

                  <!-- Order Details Grid -->
                  <div class="order-details">
                    {% if order.amount %}
                    <div
                      class="detail-item d-flex justify-content-between align-items-center mb-2"
                    >
                      <span class="text-muted small">
                        <i class="fas fa-layer-group me-2 text-primary"></i
                        >Seriya
                      </span>
                      <span class="fw-medium">{{ order.amount }}</span>
                    </div>
                    {% endif %} {% if order.created_at %}
                    <div
                      class="detail-item d-flex justify-content-between align-items-center mb-2"
                    >
                      <span class="text-muted small">
                        <i class="fas fa-calendar-plus me-2 text-success"></i
                        >Yaratilgan
                      </span>
                      <span class="fw-medium small"
                        >{{ order.created_at[:16] | replace('T', ' ') }}</span
                      >
                    </div>
                    {% endif %}

                    <div
                      class="detail-item d-flex justify-content-between align-items-center"
                    >
                      <span class="text-muted small">
                        <i class="fas fa-info-circle me-2 text-info"></i>Holat
                      </span>
                      <span
                        class="badge {% if collection.status == 'open' %}bg-success {% elif collection.status == 'close' %}bg-warning {% elif collection.status == 'finish' %}bg-primary {% else %}bg-secondary{% endif %}"
                      >
                        {% if collection.status == 'open' %}
                        <i class="fas fa-play me-1"></i>Faol {% elif
                        collection.status == 'close' %}
                        <i class="fas fa-pause me-1"></i>Yopiq {% elif
                        collection.status == 'finish' %}
                        <i class="fas fa-check me-1"></i>Tugallangan {% else %}
                        <i class="fas fa-question me-1"></i>Noma'lum {% endif %}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Action Button -->
                <div class="mt-3">
                  <button
                    class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center"
                    style="border-radius: var(--radius-md); font-weight: 500"
                  >
                    <i class="fas fa-eye me-2"></i>Tafsilotlarini ko'rish
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="empty-state text-center py-5">
    <div class="empty-icon mb-4">
      <div
        class="d-inline-flex align-items-center justify-content-center"
        style="
          width: 100px;
          height: 100px;
          border-radius: 50%;
          background: linear-gradient(
            135deg,
            var(--neutral-100),
            var(--neutral-200)
          );
          color: var(--text-tertiary);
        "
      >
        <i class="fas fa-users-slash fa-3x"></i>
      </div>
    </div>
    <h4 class="text-muted mb-2">Bu kolleksiyada buyurtmalar yo'q</h4>
    <p class="text-muted">
      Hozircha bu kolleksiya bo'yicha buyurtmalar mavjud emas.
    </p>
  </div>
  {% endfor %}
</div>

<!-- Order Details Modal -->
<div
  class="modal fade"
  id="orderDetailsModal"
  tabindex="-1"
  aria-labelledby="orderDetailsModalLabel"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
  >
    <div
      class="modal-content border-0"
      style="border-radius: var(--radius-lg); box-shadow: var(--shadow-xl)"
    >
      <div
        class="modal-header border-0 pb-2"
        style="
          background: linear-gradient(
            135deg,
            var(--primary-50),
            var(--primary-100)
          );
          border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        "
      >
        <h5
          class="modal-title fw-bold d-flex align-items-center"
          id="orderDetailsModalLabel"
        >
          <div
            class="p-2 rounded-circle me-3"
            style="background-color: var(--primary-500)"
          >
            <i class="fas fa-file-lines text-white"></i>
          </div>
          Buyurtma Tafsilotlari
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Yopish"
        ></button>
      </div>
      <div class="modal-body p-4" id="orderDetailsContent">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yuklanmoqda...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Multiple Reports Upload Modal -->
<div
  class="modal fade"
  id="multipleReportsModal"
  tabindex="-1"
  aria-labelledby="multipleReportsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div
      class="modal-content border-0"
      style="
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        background: #2c3e50;
      "
    >
      <div class="modal-header border-0 text-white pb-0">
        <h5
          class="modal-title fw-bold d-flex align-items-center"
          id="multipleReportsModalLabel"
        >
          <div
            class="p-3 rounded-circle me-3"
            style="background: rgba(255, 255, 255, 0.1)"
          >
            <i class="fas fa-paper-plane text-white"></i>
          </div>
          Kolleksiyaga Hisobotlar Yuborish
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Yopish"
        ></button>
      </div>
      <div class="modal-body p-0">
        <div
          class="p-5"
          style="background: white; margin: 15px; border-radius: 10px"
        >
          <form id="multipleReportsForm" enctype="multipart/form-data">
            <input
              type="hidden"
              id="multipleCollectionId"
              name="collection_id"
            />

            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-3">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                PDF Hisobotlarni Tanlang (Bir nechta fayl)
                <small class="text-muted d-block mt-1">
                  <i class="fas fa-info-circle me-1"></i>
                  Fayl nomi bu kolleksiyada buyurtma bergan foydalanuvchi kodi
                  bo'lishi kerak
                </small>
              </label>
              <div
                class="upload-zone"
                id="multipleUploadZone"
                style="
                  border: 2px dashed #6c757d;
                  border-radius: 10px;
                  padding: 50px 20px;
                  text-align: center;
                  background: #f8f9fa;
                  transition: all 0.3s ease;
                  cursor: pointer;
                  position: relative;
                  overflow: hidden;
                "
              >
                <div class="upload-content">
                  <div class="upload-icon mb-3">
                    <i
                      class="fas fa-cloud-upload-alt"
                      style="
                        font-size: 4rem;
                        color: #6c757d;
                        transition: all 0.3s ease;
                      "
                    ></i>
                  </div>
                  <h4 class="mb-3 fw-bold text-dark">
                    Fayllarni bu yerga tashlang
                  </h4>
                  <p class="text-muted mb-4">yoki fayl tanlash uchun bosing</p>
                  <div class="upload-specs">
                    <span class="badge bg-light text-dark px-3 py-2 me-2 mb-2">
                      <i class="fas fa-file-pdf text-danger me-1"></i>PDF
                      fayllar
                    </span>
                    <span class="badge bg-light text-dark px-3 py-2 me-2 mb-2">
                      <i class="fas fa-layer-group me-1"></i>Bir nechta fayl
                    </span>
                    <span class="badge bg-warning text-dark px-3 py-2 mb-2">
                      <i class="fas fa-user me-1"></i>Foydalanuvchi kodi
                    </span>
                  </div>
                </div>
                <input
                  type="file"
                  id="multipleReportsInput"
                  name="reports"
                  multiple
                  accept=".pdf"
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    opacity: 0;
                    cursor: pointer;
                  "
                />
              </div>
              <div
                class="selected-files mt-3"
                id="multipleSelectedFiles"
                style="display: none"
              >
                <h6 class="fw-semibold text-dark mb-2">
                  <i class="fas fa-check-circle text-success me-2"></i>Tanlangan
                  fayllar:
                </h6>
                <div class="files-list" id="multipleFilesList"></div>
              </div>
            </div>

            <div class="d-flex justify-content-end gap-3">
              <button
                type="button"
                class="btn btn-outline-secondary px-4 py-2"
                data-bs-dismiss="modal"
                style="border-radius: 15px; font-weight: 500"
              >
                <i class="fas fa-times me-2"></i>Bekor qilish
              </button>
              <button
                type="submit"
                class="btn px-5 py-2"
                style="
                  background: #2c3e50;
                  border: none;
                  border-radius: 10px;
                  color: white;
                  font-weight: 600;
                  box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
                "
                id="multipleSubmitBtn"
                disabled
              >
                <i class="fas fa-paper-plane me-2"></i>Hisobotlarni Yuborish
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Single Report Upload Modal -->
<div
  class="modal fade"
  id="singleReportModal"
  tabindex="-1"
  aria-labelledby="singleReportModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div
      class="modal-content border-0"
      style="
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        background: #495057;
      "
    >
      <div class="modal-header border-0 text-white pb-0">
        <h5
          class="modal-title fw-bold d-flex align-items-center"
          id="singleReportModalLabel"
        >
          <div
            class="p-3 rounded-circle me-3"
            style="background: rgba(255, 255, 255, 0.1)"
          >
            <i class="fas fa-file-pdf text-white"></i>
          </div>
          <span id="singleReportUserName">Foydalanuvchiga</span> Hisobot
          Yuborish
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Yopish"
        ></button>
      </div>
      <div class="modal-body p-0">
        <div
          class="p-5"
          style="background: white; margin: 15px; border-radius: 10px"
        >
          <form id="singleReportForm" enctype="multipart/form-data">
            <input type="hidden" id="singleUserId" name="user_id" />
            <input type="hidden" id="singleCollectionId" name="collection_id" />
            <input type="hidden" id="singleHasReport" value="false" />

            <div class="mb-4">
              <label class="form-label fw-semibold text-dark mb-3">
                <i class="fas fa-file-pdf text-danger me-2"></i>
                PDF Hisobotni Tanlang
                <small class="text-muted d-block mt-1">
                  <i class="fas fa-info-circle me-1"></i>
                  Fayl nomi ixtiyoriy bo'lishi mumkin (backend tomonida
                  o'zgartiriladi)
                </small>
              </label>
              <div
                class="upload-zone"
                id="singleUploadZone"
                style="
                  border: 2px dashed #6c757d;
                  border-radius: 10px;
                  padding: 50px 20px;
                  text-align: center;
                  background: #f8f9fa;
                  transition: all 0.3s ease;
                  cursor: pointer;
                  position: relative;
                  overflow: hidden;
                "
              >
                <div class="upload-content">
                  <div class="upload-icon mb-3">
                    <i
                      class="fas fa-file-upload"
                      style="
                        font-size: 4rem;
                        color: #6c757d;
                        transition: all 0.3s ease;
                      "
                    ></i>
                  </div>
                  <h4 class="mb-3 fw-bold text-dark">
                    Faylni bu yerga tashlang
                  </h4>
                  <p class="text-muted mb-4">yoki fayl tanlash uchun bosing</p>
                  <div class="upload-specs">
                    <span class="badge bg-light text-dark px-3 py-2 me-2 mb-2">
                      <i class="fas fa-file-pdf text-danger me-1"></i>PDF fayl
                    </span>
                    <span class="badge bg-light text-dark px-3 py-2 me-2 mb-2">
                      <i class="fas fa-user me-1"></i>Bitta fayl
                    </span>
                    <span class="badge bg-success text-white px-3 py-2 mb-2">
                      <i class="fas fa-check me-1"></i>Ixtiyoriy nom
                    </span>
                  </div>
                </div>
                <input
                  type="file"
                  id="singleReportInput"
                  name="report"
                  accept=".pdf"
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    opacity: 0;
                    cursor: pointer;
                  "
                />
              </div>
              <div
                class="selected-file mt-3"
                id="singleSelectedFile"
                style="display: none"
              >
                <h6 class="fw-semibold text-dark mb-2">
                  <i class="fas fa-check-circle text-success me-2"></i>Tanlangan
                  fayl:
                </h6>
                <div class="file-info" id="singleFileInfo"></div>
              </div>
            </div>

            <div class="d-flex justify-content-end gap-3">
              <button
                type="button"
                class="btn btn-outline-secondary px-4 py-2"
                data-bs-dismiss="modal"
                style="border-radius: 15px; font-weight: 500"
              >
                <i class="fas fa-times me-2"></i>Bekor qilish
              </button>
              <button
                type="submit"
                class="btn px-5 py-2"
                style="
                  background: #495057;
                  border: none;
                  border-radius: 10px;
                  color: white;
                  font-weight: 600;
                  box-shadow: 0 4px 15px rgba(73, 80, 87, 0.3);
                "
                id="singleSubmitBtn"
                disabled
              >
                <i class="fas fa-paper-plane me-2"></i>Hisobotni Yuborish
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // Enhanced user toggle functionality
  function toggleUserOrders(userId) {
    const ordersContainer = document.getElementById(
      "orders-container-" + userId
    );
    const chevron = document.getElementById("chevron-" + userId);

    if (
      ordersContainer.style.display === "none" ||
      ordersContainer.style.display === ""
    ) {
      // Show orders
      ordersContainer.style.display = "block";
      chevron.style.transform = "rotate(180deg)";
      chevron.classList.remove("fa-chevron-down");
      chevron.classList.add("fa-chevron-up");
    } else {
      // Hide orders
      ordersContainer.style.display = "none";
      chevron.style.transform = "rotate(0deg)";
      chevron.classList.remove("fa-chevron-up");
      chevron.classList.add("fa-chevron-down");
    }
  }

  // Enhanced viewOrderDetails function
  function viewOrderDetails(orderId) {
    const modal = new bootstrap.Modal(
      document.getElementById("orderDetailsModal")
    );
    const modalTitle = document.getElementById("orderDetailsModalLabel");
    const modalContent = document.getElementById("orderDetailsContent");

    modalTitle.innerHTML = `
    <div class="p-2 rounded-circle me-3" style="background-color: var(--primary-500)">
      <i class="fas fa-file-lines text-white"></i>
    </div>
    Buyurtma #${orderId} Tafsilotlari
  `;

    modalContent.innerHTML = `
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Yuklanmoqda...</span>
      </div>
      <p class="mt-3 text-muted">Ma'lumotlar yuklanmoqda...</p>
    </div>
  `;

    modal.show();

    // Fetch order details
    fetch(`/api/orders/${orderId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          modalContent.innerHTML = `
          <div class="alert alert-danger border-0" style="border-radius: var(--radius-md);">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${data.error}
          </div>
        `;
          return;
        }

        let filesHtml = `
        <div class="text-center py-4">
          <div class="d-inline-flex align-items-center justify-content-center"
               style="width: 60px; height: 60px; border-radius: 50%; background: var(--neutral-100); color: var(--text-tertiary);">
            <i class="fas fa-image fa-2x"></i>
          </div>
          <p class="mt-3 text-muted">Fayllar yo'q.</p>
        </div>
      `;

        if (data.files && data.files.length > 0) {
          filesHtml = '<div class="image-gallery row g-3">';
          data.files.forEach((filePath) => {
            const filename = filePath.split("/").pop().split("\\").pop();
            const fileUrl = `/uploads/${filename}`;
            if (filename.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/)) {
              filesHtml += `
              <div class="col-6 col-md-4 col-lg-3">
                <div class="position-relative">
                  <img src="${fileUrl}" alt="Order Image"
                       class="image-thumbnail w-100"
                       style="height: 120px; object-fit: cover; border-radius: var(--radius-md); cursor: pointer; transition: transform 0.3s ease;"
                       onclick="showImage('${fileUrl}')"
                       onmouseover="this.style.transform='scale(1.05)'"
                       onmouseout="this.style.transform='scale(1)'">
                  <div class="position-absolute top-0 end-0 m-2">
                    <span class="badge bg-dark bg-opacity-75" style="font-size: 0.7rem;">
                      <i class="fas fa-image"></i>
                    </span>
                  </div>
                </div>
              </div>
            `;
            } else if (filename.toLowerCase().match(/\.(mp4|mov|avi)$/)) {
              filesHtml += `
              <div class="col-6 col-md-4 col-lg-3">
                <div class="position-relative">
                  <video class="w-100" style="height: 120px; object-fit: cover; border-radius: var(--radius-md);" controls preload="metadata">
                    <source src="${fileUrl}" type="video/mp4">
                    Brauzeringiz video o'ynatishni qo'llab-quvvatlamaydi.
                  </video>
                  <div class="position-absolute top-0 end-0 m-2">
                    <span class="badge bg-dark bg-opacity-75" style="font-size: 0.7rem;">
                      <i class="fas fa-video"></i>
                    </span>
                  </div>
                </div>
              </div>
            `;
            } else {
              filesHtml += `
              <div class="col-6 col-md-4 col-lg-3">
                <div class="d-flex flex-column align-items-center p-3 border rounded" style="height: 120px; border-radius: var(--radius-md);">
                  <i class="fas fa-file fa-2x text-muted mb-2"></i>
                  <small class="text-muted text-center">${filename}</small>
                  <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary mt-auto">
                    <i class="fas fa-download me-1"></i>Yuklab olish
                  </a>
                </div>
              </div>
            `;
            }
          });
          filesHtml += "</div>";
        }

        const orderDate = data.created_at
          ? new Date(data.created_at).toLocaleString("uz-UZ")
          : "N/A";

        modalContent.innerHTML = `
        <div class="order-details-content">
          <!-- Order Header -->
          <div class="order-header mb-4 p-4 rounded" style="background: linear-gradient(135deg, var(--primary-50), var(--primary-100));">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="detail-item">
                  <label class="text-muted small mb-1">Buyurtma ID</label>
                  <div class="fw-bold">#${data.id}</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="detail-item">
                  <label class="text-muted small mb-1">Yaratilgan vaqti</label>
                  <div class="fw-medium">${orderDate}</div>
                </div>
              </div>
              ${
                data.amount
                  ? `
              <div class="col-md-6">
                <div class="detail-item">
                  <label class="text-muted small mb-1">Seriya</label>
                  <div class="fw-medium">${data.amount}</div>
                </div>
              </div>
              `
                  : ""
              }
              <div class="col-md-6">
                <div class="detail-item">
                  <label class="text-muted small mb-1">Fayllar soni</label>
                  <div class="fw-medium">
                    <span class="badge bg-info">
                      <i class="fas fa-paperclip me-1"></i>
                      ${data.files ? data.files.length : 0} ta
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Files Section -->
          <div class="files-section">
            <div class="d-flex align-items-center mb-3">
              <h6 class="mb-0 fw-semibold text-secondary">
                <i class="fas fa-folder-open me-2"></i>
                Yuklangan fayllar
              </h6>
              ${
                data.files && data.files.length > 0
                  ? `
                <span class="badge bg-secondary ms-2">${data.files.length} ta</span>
              `
                  : ""
              }
            </div>
            ${filesHtml}
          </div>
        </div>
      `;
      })
      .catch((error) => {
        console.error("Error fetching order details:", error);
        modalContent.innerHTML = `
        <div class="alert alert-danger border-0" style="border-radius: var(--radius-md);">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Ma'lumotlarni yuklashda xatolik yuz berdi.
        </div>
      `;
      });
  }

  // Add hover effects for order cards
  document.addEventListener("DOMContentLoaded", function () {
    // Add hover effects to order cards
    document.querySelectorAll(".order-card-enhanced").forEach((card) => {
      const overlay = card.querySelector(".image-overlay");

      card.addEventListener("mouseenter", function () {
        if (overlay) {
          overlay.style.opacity = "1";
        }
      });

      card.addEventListener("mouseleave", function () {
        if (overlay) {
          overlay.style.opacity = "0";
        }
      });
    });

    // Initialize drag and drop functionality
    initializeMultipleUpload();
    initializeSingleUpload();
  });

  // Global variable to store valid user codes for the current collection
  let validUserCodes = [];

  // Global array to store accumulated files
  let accumulatedFiles = [];

  // Multiple Reports Modal Functions
  function openMultipleReportsModal(collectionId) {
    // Check if collection is finished
    const collectionStatus = "{{ collection.status }}";
    if (collectionStatus !== "finish") {
      showErrorMessage(
        "Hisobotlar faqat tugallangan kolleksiyalarga yuboriladi!"
      );
      return;
    }

    document.getElementById("multipleCollectionId").value = collectionId;

    // Fetch valid user codes for this collection
    fetchValidUserCodes(collectionId)
      .then(() => {
        const modal = new bootstrap.Modal(
          document.getElementById("multipleReportsModal")
        );
        modal.show();
        resetMultipleUpload();
      })
      .catch((error) => {
        console.error(
          "Failed to fetch user codes, opening modal anyway:",
          error
        );
        // Open modal even if user codes failed to load
        const modal = new bootstrap.Modal(
          document.getElementById("multipleReportsModal")
        );
        modal.show();
        resetMultipleUpload();
      });
  }

  async function fetchValidUserCodes(collectionId) {
    try {
      console.log(`Fetching user codes for collection ${collectionId}`);
      const response = await fetch(
        `/api/collections/${collectionId}/user-codes`
      );

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log("API response:", data);

      if (data.success) {
        validUserCodes = data.user_codes;
        console.log(
          `Loaded ${validUserCodes.length} valid user codes for collection ${collectionId}:`,
          validUserCodes
        );

        if (validUserCodes.length === 0) {
          showErrorMessage(
            "Bu kolleksiyada hech qanday foydalanuvchi buyurtma bermagan"
          );
        }
      } else {
        console.error("Failed to fetch user codes:", data.error);
        validUserCodes = [];
        showErrorMessage(
          `Foydalanuvchi kodlarini yuklashda xatolik: ${data.error}`
        );
      }
    } catch (error) {
      console.error("Error fetching user codes:", error);
      validUserCodes = [];
      showErrorMessage(`Tarmoq xatoligi: ${error.message}`);
    }
  }

  function initializeMultipleUpload() {
    const uploadZone = document.getElementById("multipleUploadZone");
    const fileInput = document.getElementById("multipleReportsInput");
    const submitBtn = document.getElementById("multipleSubmitBtn");
    const selectedFiles = document.getElementById("multipleSelectedFiles");
    const filesList = document.getElementById("multipleFilesList");

    // Drag and drop events
    uploadZone.addEventListener("dragover", function (e) {
      e.preventDefault();
      uploadZone.style.borderColor = "#2c3e50";
      uploadZone.style.background = "#e9ecef";
      uploadZone.querySelector(".upload-icon i").style.color = "#2c3e50";
      uploadZone.querySelector(".upload-icon i").style.transform = "scale(1.1)";
    });

    uploadZone.addEventListener("dragleave", function (e) {
      e.preventDefault();
      resetMultipleUploadZone();
    });

    uploadZone.addEventListener("drop", function (e) {
      e.preventDefault();
      const newFiles = Array.from(e.dataTransfer.files).filter(
        (file) => file.type === "application/pdf"
      );

      // Add new files to accumulated files array
      newFiles.forEach((newFile) => {
        // Check if file with same name already exists
        const existingIndex = accumulatedFiles.findIndex(
          (f) => f.name === newFile.name && f.size === newFile.size
        );
        if (existingIndex === -1) {
          accumulatedFiles.push(newFile);
        }
      });

      // Update the file input with all accumulated files
      const dt = new DataTransfer();
      accumulatedFiles.forEach((file) => {
        dt.items.add(file);
      });
      fileInput.files = dt.files;

      // Handle all accumulated files
      handleMultipleFiles(accumulatedFiles);
      resetMultipleUploadZone();
    });

    fileInput.addEventListener("change", function (e) {
      const newFiles = Array.from(e.target.files);

      // Add new files to accumulated files array
      newFiles.forEach((newFile) => {
        // Check if file with same name already exists
        const existingIndex = accumulatedFiles.findIndex(
          (f) => f.name === newFile.name && f.size === newFile.size
        );
        if (existingIndex === -1) {
          accumulatedFiles.push(newFile);
        }
      });

      // Update the file input with all accumulated files
      const dt = new DataTransfer();
      accumulatedFiles.forEach((file) => {
        dt.items.add(file);
      });
      fileInput.files = dt.files;

      // Handle all accumulated files
      handleMultipleFiles(accumulatedFiles);
    });

    // Form submission
    document
      .getElementById("multipleReportsForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        submitMultipleReports();
      });
  }

  function handleMultipleFiles(files) {
    if (files.length === 0) return;

    // Validate filenames against valid user codes
    const invalidFiles = [];
    const validFiles = [];

    files.forEach((file) => {
      const filename = file.name.replace(".pdf", "").replace(".PDF", "");
      const filenameUpper = filename.toUpperCase();

      // Check if filename is exactly 4 characters
      if (filename.length !== 4) {
        invalidFiles.push({ file, filename, reason: "length" });
      } else if (
        validUserCodes.length > 0 &&
        !validUserCodes.includes(filenameUpper)
      ) {
        // Only validate against user codes if they were successfully loaded
        invalidFiles.push({ file, filename, reason: "invalid_code" });
      } else {
        validFiles.push({ file, filename });
      }
    });

    const filesList = document.getElementById("multipleFilesList");
    const selectedFiles = document.getElementById("multipleSelectedFiles");
    const submitBtn = document.getElementById("multipleSubmitBtn");

    filesList.innerHTML = "";

    // Display all files (both valid and invalid)
    [
      ...validFiles,
      ...invalidFiles.map((item) => ({
        file: item.file,
        filename: item.filename,
        reason: item.reason,
        isInvalid: true,
      })),
    ].forEach((fileInfo, index) => {
      const file = fileInfo.file;
      const filename = fileInfo.filename;
      const isInvalid = fileInfo.isInvalid;
      const reason = fileInfo.reason;

      const fileElement = document.createElement("div");
      fileElement.className =
        "file-item d-flex align-items-center justify-content-between p-3 mb-2 rounded-3";

      // Apply red background for invalid files
      if (isInvalid) {
        fileElement.style.background = "#f8d7da";
        fileElement.style.border = "1px solid #dc3545";
      } else {
        fileElement.style.background = "#f8f9fa";
        fileElement.style.border = "1px solid #dee2e6";
      }

      let errorBadge = "";
      if (isInvalid) {
        if (reason === "length") {
          errorBadge = `<span class="badge bg-danger ms-2">Noto'g'ri! ${filename.length} belgi (4 belgi kerak)</span>`;
        } else if (reason === "invalid_code") {
          errorBadge = `<span class="badge bg-danger ms-2">Noto'g'ri foydalanuvchi kodi: ${filename}</span>`;
        }
      } else {
        if (validUserCodes.length === 0) {
          errorBadge = `<span class="badge bg-warning ms-2">⚠ ${filename} (kodlar tekshirilmadi)</span>`;
        } else {
          errorBadge = `<span class="badge bg-success ms-2">✓ ${filename} (to'g'ri kod)</span>`;
        }
      }

      fileElement.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="file-icon me-3">
            <i class="fas fa-file-pdf ${
              isInvalid ? "text-danger" : "text-danger"
            }" style="font-size: 1.5rem;"></i>
          </div>
          <div class="file-info">
            <div class="fw-semibold ${
              isInvalid ? "text-danger" : "text-dark"
            }">${file.name}</div>
            <div class="text-muted small">
              ${(file.size / 1024 / 1024).toFixed(2)} MB
              ${errorBadge}
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMultipleFile(${index})">
          <i class="fas fa-times"></i>
        </button>
      `;
      filesList.appendChild(fileElement);
    });

    selectedFiles.style.display = "block";

    // Disable submit button if there are any invalid files or no valid files
    submitBtn.disabled = invalidFiles.length > 0 || validFiles.length === 0;
  }

  function removeMultipleFile(index) {
    // Remove file from accumulated files array
    accumulatedFiles.splice(index, 1);

    // Update the file input with remaining files
    const fileInput = document.getElementById("multipleReportsInput");
    const dt = new DataTransfer();

    accumulatedFiles.forEach((file) => {
      dt.items.add(file);
    });

    fileInput.files = dt.files;

    // Refresh the display
    if (accumulatedFiles.length === 0) {
      resetMultipleUpload();
    } else {
      handleMultipleFiles(accumulatedFiles);
    }
  }

  function resetMultipleUpload() {
    document.getElementById("multipleReportsInput").value = "";
    document.getElementById("multipleSelectedFiles").style.display = "none";
    document.getElementById("multipleSubmitBtn").disabled = true;
    accumulatedFiles = []; // Clear accumulated files
    resetMultipleUploadZone();
  }

  function resetMultipleUploadZone() {
    const uploadZone = document.getElementById("multipleUploadZone");
    uploadZone.style.borderColor = "#6c757d";
    uploadZone.style.background = "#f8f9fa";
    uploadZone.querySelector(".upload-icon i").style.color = "#6c757d";
    uploadZone.querySelector(".upload-icon i").style.transform = "scale(1)";
  }

  function submitMultipleReports() {
    const fileInput = document.getElementById("multipleReportsInput");
    const files = Array.from(fileInput.files);

    // Check if all files have valid filenames (exactly 4 characters and valid user codes)
    const invalidFiles = files.filter((file) => {
      const filename = file.name.replace(".pdf", "").replace(".PDF", "");
      const filenameUpper = filename.toUpperCase();

      // Always check length
      if (filename.length !== 4) return true;

      // Only check user codes if they were loaded successfully
      if (
        validUserCodes.length > 0 &&
        !validUserCodes.includes(filenameUpper)
      ) {
        return true;
      }

      return false;
    });

    if (invalidFiles.length > 0) {
      if (validUserCodes.length === 0) {
        showErrorMessage("Barcha fayllar nomi aniq 4 belgi bo'lishi kerak!");
      } else {
        showErrorMessage(
          "Barcha fayllar nomi to'g'ri foydalanuvchi kodi bo'lishi kerak!"
        );
      }
      return;
    }

    const form = document.getElementById("multipleReportsForm");
    const formData = new FormData();
    const submitBtn = document.getElementById("multipleSubmitBtn");

    // Add collection ID
    formData.append(
      "collection_id",
      document.getElementById("multipleCollectionId").value
    );

    // Add only valid files
    files.forEach((file) => {
      formData.append("reports", file);
    });

    submitBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin me-2"></i>Yuklanmoqda...';
    submitBtn.disabled = true;

    fetch("/api/send-multiple-reports", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showSuccessMessage("Hisobotlar muvaffaqiyatli yuborildi!");
          bootstrap.Modal.getInstance(
            document.getElementById("multipleReportsModal")
          ).hide();
        } else {
          showErrorMessage(data.message || "Xatolik yuz berdi");
        }
      })
      .catch((error) => {
        showErrorMessage("Tarmoq xatoligi");
        console.error("Error:", error);
      })
      .finally(() => {
        submitBtn.innerHTML =
          '<i class="fas fa-paper-plane me-2"></i>Hisobotlarni Yuborish';
        submitBtn.disabled = false;
      });
  }

  // Single Report Modal Functions
  function openSingleReportModal(userId, userName, collectionId, hasReport) {
    // Check if collection is finished
    const collectionStatus = "{{ collection.status }}";
    if (collectionStatus !== "finish") {
      showErrorMessage(
        "Hisobotlar faqat tugallangan kolleksiyalarga yuboriladi!"
      );
      return;
    }

    document.getElementById("singleCollectionId").value = collectionId;
    document.getElementById("singleUserId").value = userId;
    document.getElementById("singleReportUserName").textContent = userName;
    document.getElementById("singleHasReport").value = hasReport
      ? "true"
      : "false";

    // Update modal title based on whether it's an update or new report
    const modalTitle = document.getElementById("singleReportModalLabel");
    if (hasReport) {
      modalTitle.innerHTML = `
        <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.1)">
          <i class="fas fa-sync text-white"></i>
        </div>
        <span id="singleReportUserName">${userName}</span> uchun Hisobotni Yangilash
      `;
    } else {
      modalTitle.innerHTML = `
        <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.1)">
          <i class="fas fa-file-pdf text-white"></i>
        </div>
        <span id="singleReportUserName">${userName}</span> Hisobot Yuborish
      `;
    }

    const modal = new bootstrap.Modal(
      document.getElementById("singleReportModal")
    );
    modal.show();
    resetSingleUpload();
    const submitBtn = document.getElementById("singleSubmitBtn");
    if (hasReport) {
      submitBtn.innerHTML =
        '<i class="fas fa-sync me-2"></i>Hisobotni Yangilash';
    } else {
      submitBtn.innerHTML =
        '<i class="fas fa-paper-plane me-2"></i>Hisobotni Yuborish';
    }
  }

  function initializeSingleUpload() {
    const uploadZone = document.getElementById("singleUploadZone");
    const fileInput = document.getElementById("singleReportInput");
    const submitBtn = document.getElementById("singleSubmitBtn");

    // Drag and drop events
    uploadZone.addEventListener("dragover", function (e) {
      e.preventDefault();
      uploadZone.style.borderColor = "#495057";
      uploadZone.style.background = "#e9ecef";
      uploadZone.querySelector(".upload-icon i").style.color = "#495057";
      uploadZone.querySelector(".upload-icon i").style.transform = "scale(1.1)";
    });

    uploadZone.addEventListener("dragleave", function (e) {
      e.preventDefault();
      resetSingleUploadZone();
    });

    uploadZone.addEventListener("drop", function (e) {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files).filter(
        (file) => file.type === "application/pdf"
      );
      if (files.length > 0) {
        handleSingleFile(files[0]);
      }
      resetSingleUploadZone();
    });

    fileInput.addEventListener("change", function (e) {
      if (e.target.files.length > 0) {
        handleSingleFile(e.target.files[0]);
      }
    });

    // Form submission
    document
      .getElementById("singleReportForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        submitSingleReport();
      });
  }

  function handleSingleFile(file) {
    const fileInfo = document.getElementById("singleFileInfo");
    const selectedFile = document.getElementById("singleSelectedFile");
    const submitBtn = document.getElementById("singleSubmitBtn");

    // Ensure the file input actually contains the selected/dropped file
    updateFileInput([file], "singleReportInput");

    const filename = file.name.replace(".pdf", "").replace(".PDF", "");
    fileInfo.innerHTML = `
      <div class="file-item d-flex align-items-center justify-content-between p-3 rounded-3"
           style="background: #f8f9fa; border: 1px solid #495057;">
        <div class="d-flex align-items-center">
          <div class="file-icon me-3">
            <i class="fas fa-file-pdf text-danger" style="font-size: 1.5rem;"></i>
          </div>
          <div class="file-info">
            <div class="fw-semibold text-dark">${file.name}</div>
            <div class="text-muted small">
              ${(file.size / 1024 / 1024).toFixed(2)} MB
              <span class="badge bg-info ms-2">
                <i class="fas fa-edit me-1"></i>Backend tomonida o'zgartiriladi
              </span>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="resetSingleUpload()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

    selectedFile.style.display = "block";
    submitBtn.disabled = false;
  }

  function resetSingleUpload() {
    document.getElementById("singleReportInput").value = "";
    document.getElementById("singleSelectedFile").style.display = "none";
    document.getElementById("singleSubmitBtn").disabled = true;
    resetSingleUploadZone();
  }

  function resetSingleUploadZone() {
    const uploadZone = document.getElementById("singleUploadZone");
    uploadZone.style.borderColor = "#6c757d";
    uploadZone.style.background = "#f8f9fa";
    uploadZone.querySelector(".upload-icon i").style.color = "#6c757d";
    uploadZone.querySelector(".upload-icon i").style.transform = "scale(1)";
  }

  function submitSingleReport() {
    const form = document.getElementById("singleReportForm");
    const formData = new FormData(form);
    const submitBtn = document.getElementById("singleSubmitBtn");

    submitBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin me-2"></i>Yuklanmoqda...';
    submitBtn.disabled = true;

    fetch("/api/send-single-report", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showSuccessMessage("Hisobot muvaffaqiyatli yuborildi!");
          bootstrap.Modal.getInstance(
            document.getElementById("singleReportModal")
          ).hide();
          // Update UI: mark user as having a report and toggle button to Update
          const uid = document.getElementById("singleUserId").value;
          const reportBtn = document.getElementById("report-button-" + uid);
          if (reportBtn) {
            reportBtn.innerHTML =
              '<i class="fas fa-sync me-1"></i>Hisobotni Yangilash';
          }

          // Show green indicator light
          const indicator = document.getElementById("report-indicator-" + uid);
          if (indicator && indicator.style.display === "none") {
            indicator.style.cssText = `
              position: absolute;
              top: 0;
              right: 0;
              bottom: 0;
              width: 8px;
              background: linear-gradient(135deg, #10b981, #059669);
              box-shadow: -2px 0 20px rgba(16, 185, 129, 0.5), -4px 0 40px rgba(16, 185, 129, 0.3);
              border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
              z-index: 5;
              animation: pulse-green-bg 2s ease-in-out infinite;
              display: block;
            `;
            indicator.title = "Hisobot yuborilgan";
          }

          document.getElementById("singleHasReport").value = "true";
        } else {
          showErrorMessage(data.message || "Xatolik yuz berdi");
        }
      })
      .catch((error) => {
        showErrorMessage("Tarmoq xatoligi");
        console.error("Error:", error);
      })
      .finally(() => {
        const hasReport =
          document.getElementById("singleHasReport").value === "true";
        submitBtn.innerHTML = hasReport
          ? '<i class="fas fa-sync me-2"></i>Hisobotni Yangilash'
          : '<i class="fas fa-paper-plane me-2"></i>Hisobotni Yuborish';
        submitBtn.disabled = false;
      });
  }

  // Utility functions for notifications
  function showSuccessMessage(message) {
    // Create and show success toast or alert
    const alertDiv = document.createElement("div");
    alertDiv.className = "alert alert-success alert-dismissible position-fixed";
    alertDiv.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    alertDiv.innerHTML = `
      <i class="fas fa-check-circle me-2"></i>${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 5000);
  }

  function showErrorMessage(message) {
    // Create and show error toast or alert
    const alertDiv = document.createElement("div");
    alertDiv.className = "alert alert-danger alert-dismissible position-fixed";
    alertDiv.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; white-space: pre-line;";
    alertDiv.innerHTML = `
      <i class="fas fa-exclamation-triangle me-2"></i>${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 8000);
  }

  // Helper function to update file input with valid files
  function updateFileInput(validFiles, inputId) {
    const fileInput = document.getElementById(inputId);
    const dt = new DataTransfer();

    validFiles.forEach((file) => {
      dt.items.add(file);
    });

    fileInput.files = dt.files;
  }
</script>
{% endblock %}
