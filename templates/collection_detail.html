{% extends "base.html" %} {% block title %}Kolleksiya #{{ collection.id }} -
Buyurtmalar Boshqaruvi{% endblock %} {% block content %}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Boshqaruv Paneli</a></li>
    <li class="breadcrumb-item"><a href="/collections">Kolleksiyalar</a></li>
    <li class="breadcrumb-item active" aria-current="page">
      Kolleksiya #{{ collection.id }}
    </li>
  </ol>
</nav>

<!-- Collection Header -->
<div
  class="card mb-3 mb-md-4"
  style="
    background: var(--bg-secondary);
    border: 1px solid var(--separator);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  "
>
  <div class="card-body" style="padding: var(--spacing-lg)">
    <div class="row align-items-start">
      <div class="col-12">
        <div class="d-flex align-items-center gap-2 gap-md-3 mb-3">
          <div
            class="p-2 p-md-3 flex-shrink-0"
            style="
              background: linear-gradient(
                135deg,
                var(--primary-500),
                var(--primary-600)
              );
              border-radius: var(--radius-md);
            "
          >
            <i class="fas fa-folder-open text-white fs-5 fs-md-4"></i>
          </div>
          <div class="flex-grow-1 min-width-0">
            <h2
              class="mb-1 fw-bold fs-4 fs-md-2"
              style="color: var(--text-primary)"
            >
              Kolleksiya #{{ collection.id }}
            </h2>
            <div
              class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 gap-md-3"
            >
              <span
                class="badge px-2 px-md-3 py-1 py-md-2"
                style="font-size: 0.8rem; background: var(--{{ collection.status_class }}-100); color: var(--{{ collection.status_class }}-800); border: 1px solid var(--{{ collection.status_class }}-200);"
              >
                {{ collection.status_icon }} {{ collection.status_text }}
              </span>
              {% if collection.created_at %}
              <small style="font-size: 0.8rem; color: var(--text-secondary)">
                <i class="fas fa-calendar-plus me-1"></i>
                <span class="d-none d-md-inline">Yaratilgan: </span>{{
                collection.created_at[:10] }}
              </small>
              {% endif %} {% if collection.close_at and collection.status in
              ['close', 'finish'] %}
              <small
                class="d-none d-md-inline"
                style="font-size: 0.8rem; color: var(--text-secondary)"
              >
                <i class="fas fa-calendar-times me-1"></i>
                Yopilgan: {{ collection.close_at[:10] }}
              </small>
              {% endif %} {% if collection.finish_at and collection.status ==
              'finish' %}
              <small
                class="d-none d-md-inline"
                style="font-size: 0.8rem; color: var(--text-secondary)"
              >
                <i class="fas fa-calendar-check me-1"></i>
                Tugallangan: {{ collection.finish_at[:10] }}
              </small>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div
          class="d-flex flex-column flex-md-row gap-2 justify-content-md-end"
        >
          {% if collection.status == 'close' %}
          <div class="d-flex flex-column flex-md-row gap-2">
            <form
              action="/collections/set_status"
              method="post"
              class="flex-fill flex-md-grow-0"
            >
              <input
                type="hidden"
                name="collection_id"
                value="{{ collection.id }}"
              />
              <input type="hidden" name="status" value="open" />
              <button
                type="submit"
                class="btn btn-success w-100 w-md-auto btn-sm"
              >
                <i class="fas fa-play me-2"></i>
                <span class="d-md-none">Qayta Ochish</span>
                <span class="d-none d-md-inline">Qayta Ochish</span>
              </button>
            </form>
            <form
              action="/collections/set_status"
              method="post"
              class="flex-fill flex-md-grow-0"
            >
              <input
                type="hidden"
                name="collection_id"
                value="{{ collection.id }}"
              />
              <input type="hidden" name="status" value="finish" />
              <button type="submit" class="btn btn-info w-100 w-md-auto btn-sm">
                <i class="fas fa-check me-2"></i>
                <span class="d-md-none">Tugatish</span>
                <span class="d-none d-md-inline">Tugatish</span>
              </button>
            </form>
          </div>
          {% elif collection.status == 'finish' %}
          <button class="btn btn-secondary w-100 w-md-auto btn-sm" disabled>
            <i class="fas fa-check-circle me-2"></i>
            <span class="d-md-none">Tugallangan</span>
            <span class="d-none d-md-inline">Tugallangan</span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Collection Statistics -->
<div class="row g-2 g-md-3 mb-4">
  <div class="col-4 col-md-4">
    <div
      class="card h-100"
      style="
        background: var(--bg-secondary);
        border: 1px solid var(--separator);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
      "
    >
      <div class="card-body text-center p-2 p-md-3">
        <div
          class="p-2 p-md-3 d-inline-flex align-items-center justify-content-center mb-2"
          style="
            background: var(--primary-100);
            border-radius: var(--radius-md);
          "
        >
          <i
            class="fas fa-users fs-5 fs-md-3"
            style="color: var(--primary-600)"
          ></i>
        </div>
        <h4 class="fw-bold mb-1 fs-5 fs-md-3" style="color: var(--primary-600)">
          {{ collection.user_count or 0 }}
        </h4>
        <p
          class="mb-0 small d-none d-md-block"
          style="color: var(--text-secondary)"
        >
          Foydalanuvchilar
        </p>
        <p
          class="mb-0 d-md-none"
          style="font-size: 0.7rem; color: var(--text-secondary)"
        >
          Foydalanuvchi
        </p>
      </div>
    </div>
  </div>
  <div class="col-4 col-md-4">
    <div
      class="card h-100"
      style="
        background: var(--bg-secondary);
        border: 1px solid var(--separator);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
      "
    >
      <div class="card-body text-center p-2 p-md-3">
        <div
          class="p-2 p-md-3 d-inline-flex align-items-center justify-content-center mb-2"
          style="
            background: var(--success-100);
            border-radius: var(--radius-md);
          "
        >
          <i
            class="fas fa-shopping-cart fs-5 fs-md-3"
            style="color: var(--success-600)"
          ></i>
        </div>
        <h4 class="fw-bold mb-1 fs-5 fs-md-3" style="color: var(--success-600)">
          {{ collection.order_count or 0 }}
        </h4>
        <p
          class="mb-0 small d-none d-md-block"
          style="color: var(--text-secondary)"
        >
          Buyurtmalar
        </p>
        <p
          class="mb-0 d-md-none"
          style="font-size: 0.7rem; color: var(--text-secondary)"
        >
          Buyurtma
        </p>
      </div>
    </div>
  </div>
  <div class="col-4 col-md-4">
    <div
      class="card h-100"
      style="
        background: var(--bg-secondary);
        border: 1px solid var(--separator);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
      "
    >
      <div class="card-body text-center p-2 p-md-3">
        <div
          class="p-2 p-md-3 d-inline-flex align-items-center justify-content-center mb-2"
          style="background: var(--info-100); border-radius: var(--radius-md)"
        >
          <i
            class="fas fa-images fs-5 fs-md-3"
            style="color: var(--info-600)"
          ></i>
        </div>
        <h4 class="fw-bold mb-1 fs-5 fs-md-3" style="color: var(--info-600)">
          {% set total_files = 0 %} {% for user in users %} {% for order in
          user.orders %} {% if order.files %} {% set total_files = total_files +
          order.files|length %} {% endif %} {% endfor %} {% endfor %} {{
          total_files }}
        </h4>
        <p
          class="mb-0 small d-none d-md-block"
          style="color: var(--text-secondary)"
        >
          Jami Fayllar
        </p>
        <p
          class="mb-0 d-md-none"
          style="font-size: 0.7rem; color: var(--text-secondary)"
        >
          Fayl
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Users and Orders Section -->
<div
  class="card"
  style="
    background: var(--bg-secondary);
    border: 1px solid var(--separator);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  "
>
  <div
    class="card-header border-0"
    style="
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      padding: var(--spacing-lg);
    "
  >
    <!-- Desktop Layout -->
    <div class="d-none d-lg-flex justify-content-between align-items-center">
      <!-- Left side - Title -->
      <div class="d-flex align-items-center">
        <div
          style="
            padding: var(--spacing-sm);
            background: linear-gradient(
              135deg,
              var(--primary-500),
              var(--primary-600)
            );
            border-radius: var(--radius-md);
            margin-right: var(--spacing-md);
          "
        >
          <i class="fas fa-users text-white"></i>
        </div>
        <h5 class="mb-0 fw-semibold" style="color: var(--text-primary)">
          Buyurtma Bergan Foydalanuvchilar
        </h5>
      </div>

      <!-- Right side - Count and Buttons -->
      {% if users %}
      <div class="d-flex align-items-center gap-3">
        <span
          class="fs-6"
          style="
            background: var(--primary-100);
            color: var(--primary-700);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--primary-200);
          "
        >
          <i class="fas fa-users me-1"></i>
          {{ users|length }} ta foydalanuvchi
        </span>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm"
            onclick="collapseAllUsers()"
            title="Barchasini yig'ish"
            style="
              background: var(--neutral-100);
              color: var(--neutral-700);
              border: 1px solid var(--neutral-300);
              padding: var(--spacing-xs) var(--spacing-sm);
              border-radius: var(--radius-sm);
            "
          >
            <i class="fas fa-compress-alt me-1"></i>
            Yig'ish
          </button>
          <button
            class="btn btn-sm"
            onclick="expandAllUsers()"
            title="Barchasini ochish"
            style="
              background: var(--primary-100);
              color: var(--primary-700);
              border: 1px solid var(--primary-300);
              padding: var(--spacing-xs) var(--spacing-sm);
              border-radius: var(--radius-sm);
            "
          >
            <i class="fas fa-expand-alt me-1"></i>
            Ochish
          </button>
        </div>
      </div>
      {% else %}
      <div style="color: var(--text-secondary)">
        <i class="fas fa-info-circle me-1"></i>
        Foydalanuvchilar yo'q
      </div>
      {% endif %}
    </div>

    <!-- Mobile Layout -->
    <div class="d-lg-none">
      <!-- Title Row -->
      <div class="d-flex align-items-center mb-3">
        <div
          style="
            padding: var(--spacing-xs);
            background: linear-gradient(
              135deg,
              var(--primary-500),
              var(--primary-600)
            );
            border-radius: var(--radius-sm);
            margin-right: var(--spacing-sm);
          "
        >
          <i class="fas fa-users text-white"></i>
        </div>
        <h6 class="mb-0 fw-semibold" style="color: var(--text-primary)">
          Foydalanuvchilar
        </h6>
      </div>

      {% if users %}
      <!-- Controls Row -->
      <div class="d-flex justify-content-between align-items-center">
        <span
          style="
            background: var(--primary-100);
            color: var(--primary-700);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--primary-200);
          "
        >
          {{ users|length }} ta
        </span>
        <div class="d-flex gap-1">
          <button
            class="btn btn-sm"
            onclick="collapseAllUsers()"
            style="
              background: var(--neutral-100);
              color: var(--neutral-700);
              border: 1px solid var(--neutral-300);
              padding: var(--spacing-xs);
              border-radius: var(--radius-sm);
            "
          >
            <i class="fas fa-compress-alt"></i>
          </button>
          <button
            class="btn btn-sm"
            onclick="expandAllUsers()"
            style="
              background: var(--primary-100);
              color: var(--primary-700);
              border: 1px solid var(--primary-300);
              padding: var(--spacing-xs);
              border-radius: var(--radius-sm);
            "
          >
            <i class="fas fa-expand-alt"></i>
          </button>
        </div>
      </div>
      {% else %}
      <div class="small" style="color: var(--text-secondary)">
        <i class="fas fa-info-circle me-1"></i>
        Foydalanuvchilar yo'q
      </div>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    {% if users %}
    <div class="list-group list-group-flush">
      {% for user in users %}
      <div class="list-group-item">
        <!-- User Header (Clickable) -->
        <div
          class="user-card d-flex justify-content-between align-items-center"
          onclick="toggleUser({{ user.id }})"
          style="
            cursor: pointer;
            padding: var(--spacing-sm) var(--spacing-md);
            transition: var(--transition-fast);
          "
        >
          <div class="d-flex align-items-center flex-grow-1">
            <div class="flex-shrink-0" style="margin-right: var(--spacing-md)">
              <div
                class="text-white rounded-circle d-flex align-items-center justify-content-center"
                style="
                  width: 40px;
                  height: 40px;
                  background: linear-gradient(
                    135deg,
                    var(--primary-500),
                    var(--primary-600)
                  );
                  border-radius: var(--radius-md);
                "
              >
                <i class="fas fa-user" style="font-size: 0.9rem"></i>
              </div>
            </div>
            <div class="flex-grow-1 min-width-0">
              <h6
                class="mb-1 fw-semibold text-truncate"
                style="font-size: 0.95rem; color: var(--text-primary)"
              >
                {{ user.name or 'Nomi yo\'q' }} {{ user.surname or '' }}
              </h6>
              <div
                class="d-flex flex-column flex-md-row align-items-start align-items-md-center"
                style="gap: var(--spacing-xs) var(--spacing-md)"
              >
                <small
                  class="text-truncate"
                  style="font-size: 0.8rem; color: var(--text-secondary)"
                >
                  <i class="fas fa-phone me-1"></i>
                  {{ user.phone or 'Telefon yo\'q' }}
                </small>
                <small
                  class="d-none d-md-inline"
                  style="font-size: 0.8rem; color: var(--text-secondary)"
                >
                  <i class="fas fa-key me-1"></i>
                  Kod: {{ user.code or 'N/A' }}
                </small>
                <span
                  style="
                    font-size: 0.7rem;
                    background: var(--primary-100);
                    color: var(--primary-700);
                    padding: var(--spacing-xs) var(--spacing-sm);
                    border-radius: var(--radius-sm);
                    border: 1px solid var(--primary-200);
                  "
                >
                  {{ user.order_count }} buyurtma
                </span>
              </div>
            </div>
          </div>
          <div
            class="d-flex align-items-center flex-shrink-0"
            style="gap: var(--spacing-sm)"
          >
            <div class="text-end d-none d-md-block">
              <div
                class="fw-semibold"
                style="font-size: 0.85rem; color: var(--primary-600)"
              >
                {{ user.order_count }} buyurtma
              </div>
              <small
                id="text-{{ user.id }}"
                style="font-size: 0.75rem; color: var(--text-tertiary)"
                >Ochish uchun bosing</small
              >
            </div>
            <i
              class="fas fa-chevron-down"
              id="icon-{{ user.id }}"
              style="
                font-size: 0.9rem;
                color: var(--text-secondary);
                transition: var(--transition-fast);
              "
            ></i>
          </div>
        </div>

        <!-- User Orders (Expandable) -->
        <div class="user-orders" id="orders-{{ user.id }}">
          <div
            style="
              border-top: 1px solid var(--separator);
              padding: var(--spacing-md);
              background: var(--bg-tertiary);
              margin: 0 calc(-1 * var(--spacing-md));
            "
          >
            <h6
              class="mb-2 mb-md-3"
              style="font-size: 0.9rem; color: var(--text-secondary)"
            >
              <i class="fas fa-list me-2"></i>
              <span class="d-none d-md-inline"
                >{{ user.name or 'Bu foydalanuvchi' }}ning buyurtmalari:</span
              >
              <span class="d-md-none">Buyurtmalar:</span>
            </h6>

            {% if user.orders %}
            <div class="row g-3">
              {% for order in user.orders %} {% if order.status == 1 %}
              <!-- Only show active orders -->
              <div class="col-12 col-sm-6 col-lg-6 col-xl-3">
                <div
                  class="card h-100 order-card"
                  style="
                    background: linear-gradient(
                      145deg,
                      var(--bg-secondary),
                      var(--bg-tertiary)
                    );
                    border: 1px solid var(--separator);
                    border-radius: var(--radius-lg);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08),
                      0 2px 4px rgba(0, 0, 0, 0.05);
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    position: relative;
                    overflow: hidden;
                  "
                >
                  <!-- Decorative gradient overlay -->
                  <div
                    style="
                      position: absolute;
                      top: 0;
                      right: 0;
                      width: 60px;
                      height: 60px;
                      background: linear-gradient(
                        135deg,
                        var(--primary-100),
                        var(--primary-200)
                      );
                      opacity: 0.7;
                      border-radius: 0 var(--radius-lg) 0 50px;
                    "
                  ></div>

                  <div
                    class="card-body"
                    style="
                      padding: var(--spacing-lg);
                      position: relative;
                      z-index: 1;
                    "
                  >
                    <div
                      class="d-flex justify-content-between align-items-start mb-3"
                    >
                      <h6
                        class="mb-0 fw-bold"
                        style="color: var(--primary-600); font-size: 0.95rem"
                      >
                        <i
                          class="fas fa-shopping-bag me-2"
                          style="
                            padding: 6px;
                            background: var(--primary-100);
                            border-radius: var(--radius-sm);
                            color: var(--primary-600);
                          "
                        ></i>
                        Buyurtma #{{ order.id }}
                      </h6>
                      <span
                        class="status-badge"
                        style="
                          padding: var(--spacing-xs) var(--spacing-sm);
                          border-radius: var(--radius-md);
                          font-size: 0.7rem;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.5px;
                          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                          {% if order.collection_status == 'open' %}
                            background: linear-gradient(135deg, var(--success-100), var(--success-200));
                            color: var(--success-700);
                            border: 1px solid var(--success-300);
                          {% elif order.collection_status == 'close' %}
                            background: linear-gradient(135deg, var(--warning-100), var(--warning-200));
                            color: var(--warning-700);
                            border: 1px solid var(--warning-300);
                          {% else %}
                            background: linear-gradient(135deg, var(--info-100), var(--info-200));
                            color: var(--info-700);
                            border: 1px solid var(--info-300);
                          {% endif %}
                        "
                      >
                        {% if order.collection_status == 'open' %}
                        <i
                          class="fas fa-circle"
                          style="
                            font-size: 6px;
                            margin-right: 4px;
                            color: var(--success-500);
                          "
                        ></i
                        >Faol {% elif order.collection_status == 'close' %}
                        <i
                          class="fas fa-pause"
                          style="font-size: 8px; margin-right: 4px"
                        ></i
                        >Yopiq {% elif order.collection_status == 'finish' %}
                        <i
                          class="fas fa-check"
                          style="font-size: 8px; margin-right: 4px"
                        ></i
                        >Tugallangan {% else %}
                        <i
                          class="fas fa-question"
                          style="font-size: 8px; margin-right: 4px"
                        ></i
                        >Noma'lum {% endif %}
                      </span>
                    </div>

                    <div class="mb-3">
                      <div
                        style="
                          background: var(--bg-tertiary);
                          border-radius: var(--radius-md);
                          padding: var(--spacing-sm) var(--spacing-md);
                          border-left: 3px solid var(--primary-400);
                        "
                      >
                        <div
                          class="d-flex justify-content-between align-items-center"
                        >
                          <small
                            style="
                              color: var(--text-secondary);
                              font-weight: 500;
                            "
                          >
                            <i
                              class="fas fa-barcode me-2"
                              style="color: var(--primary-500)"
                            ></i>
                            Seriya:
                          </small>
                          <strong
                            style="color: var(--primary-600); font-size: 0.9rem"
                            >{{ order.amount or 'N/A' }}</strong
                          >
                        </div>
                      </div>
                    </div>

                    {% if order.created_at %}
                    <div class="mb-3">
                      <div
                        class="d-flex align-items-center"
                        style="
                          background: rgba(var(--primary-500-rgb), 0.05);
                          border-radius: var(--radius-sm);
                          padding: var(--spacing-xs) var(--spacing-sm);
                        "
                      >
                        <i
                          class="fas fa-clock me-2"
                          style="color: var(--primary-500); font-size: 0.8rem"
                        ></i>
                        <small
                          style="color: var(--text-secondary); font-weight: 500"
                        >
                          {{ order.created_at[:16] | replace('T', ' ') }}
                        </small>
                      </div>
                    </div>
                    {% endif %}

                    <!-- Order Thumbnail Preview -->
                    {% if order.display_image_url %}
                    <div class="mb-3">
                      <div
                        class="position-relative image-container"
                        style="
                          border-radius: var(--radius-lg);
                          overflow: hidden;
                          background: linear-gradient(
                            145deg,
                            var(--bg-tertiary),
                            var(--bg-secondary)
                          );
                          box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
                        "
                      >
                        <img
                          src="/{{ order.display_image_url }}"
                          alt="Order preview"
                          class="w-100 order-image"
                          style="
                            height: 140px;
                            object-fit: cover;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            filter: brightness(1.02) contrast(1.05);
                          "
                          onclick="viewOrderDetails({{ order.id }})"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <!-- Image overlay for better interaction -->
                        <div
                          style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(
                              45deg,
                              rgba(0, 0, 0, 0),
                              rgba(0, 0, 0, 0.1)
                            );
                            opacity: 0;
                            transition: opacity 0.3s ease;
                            pointer-events: none;
                          "
                          class="image-overlay"
                        ></div>
                        <!-- View button overlay -->
                        <div
                          style="
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            background: rgba(0, 0, 0, 0.7);
                            color: white;
                            border-radius: var(--radius-sm);
                            padding: 4px 8px;
                            font-size: 0.7rem;
                            opacity: 0;
                            transform: translateY(-10px);
                            transition: all 0.3s ease;
                          "
                          class="view-hint"
                        >
                          <i class="fas fa-eye me-1"></i>Ko'rish
                        </div>
                        <div
                          class="w-100 d-flex align-items-center justify-content-center"
                          style="
                            height: 140px;
                            display: none;
                            color: var(--text-secondary);
                            background: var(--bg-tertiary);
                          "
                        >
                          <div class="text-center">
                            <i
                              class="fas fa-image-slash fs-4 mb-2"
                              style="color: var(--text-tertiary)"
                            ></i>
                            <div class="small">Rasm yuklanmadi</div>
                          </div>
                        </div>
                      </div>
                      {% if order.files and order.files|length > 1 %}
                      <div class="mt-2 text-center">
                        <span
                          style="
                            background: var(--info-100);
                            color: var(--info-700);
                            padding: var(--spacing-xs) var(--spacing-sm);
                            border-radius: var(--radius-md);
                            font-size: 0.75rem;
                            font-weight: 500;
                            border: 1px solid var(--info-200);
                          "
                        >
                          <i class="fas fa-images me-1"></i>
                          +{{ order.files|length - 1 }} ko'proq fayl
                        </span>
                      </div>
                      {% endif %}
                    </div>
                    {% elif order.files %}
                    <div class="mb-3">
                      <div
                        class="w-100 d-flex align-items-center justify-content-center position-relative"
                        style="
                          height: 140px;
                          background: linear-gradient(
                            135deg,
                            var(--info-50),
                            var(--info-100)
                          );
                          border-radius: var(--radius-lg);
                          color: var(--info-700);
                          cursor: pointer;
                          border: 2px dashed var(--info-300);
                          transition: all 0.3s ease;
                          overflow: hidden;
                        "
                        onclick="viewOrderDetails({{ order.id }})"
                      >
                        <div class="text-center position-relative z-index-1">
                          <div
                            style="
                              background: var(--info-200);
                              width: 50px;
                              height: 50px;
                              border-radius: 50%;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              margin: 0 auto 8px;
                              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                            "
                          >
                            <i
                              class="fas fa-folder-open fs-5"
                              style="color: var(--info-600)"
                            ></i>
                          </div>
                          <div class="fw-semibold" style="font-size: 0.9rem">
                            {{ order.files|length }} ta fayl
                          </div>
                          <div class="small opacity-75">
                            Ko'rish uchun bosing
                          </div>
                        </div>
                        <!-- Animated background pattern -->
                        <div
                          style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: repeating-linear-gradient(
                              45deg,
                              transparent,
                              transparent 10px,
                              rgba(255, 255, 255, 0.05) 10px,
                              rgba(255, 255, 255, 0.05) 20px
                            );
                            opacity: 0.3;
                          "
                        ></div>
                      </div>
                    </div>
                    {% else %}
                    <div class="mb-3">
                      <div
                        class="w-100 d-flex align-items-center justify-content-center"
                        style="
                          height: 140px;
                          background: linear-gradient(
                            135deg,
                            var(--neutral-50),
                            var(--neutral-100)
                          );
                          border-radius: var(--radius-lg);
                          color: var(--text-tertiary);
                          border: 2px dashed var(--neutral-300);
                        "
                      >
                        <div class="text-center">
                          <div
                            style="
                              background: var(--neutral-200);
                              width: 40px;
                              height: 40px;
                              border-radius: 50%;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              margin: 0 auto 8px;
                            "
                          >
                            <i class="fas fa-file-slash fs-6"></i>
                          </div>
                          <div class="small">Fayllar yo'q</div>
                        </div>
                      </div>
                    </div>
                    {% endif %}

                    <!-- Order Actions -->
                    <div
                      class="d-flex justify-content-center mt-auto pt-2"
                      style="gap: var(--spacing-xs)"
                    >
                      <button
                        class="btn btn-sm action-btn"
                        onclick="viewOrderDetails({{ order.id }})"
                        title="Buyurtma tafsilotlarini ko'rish"
                        style="
                          background: linear-gradient(
                            135deg,
                            var(--primary-500),
                            var(--primary-600)
                          );
                          color: white;
                          border: none;
                          padding: var(--spacing-sm) var(--spacing-md);
                          border-radius: var(--radius-md);
                          font-weight: 600;
                          font-size: 0.85rem;
                          box-shadow: 0 2px 8px
                            rgba(var(--primary-500-rgb), 0.3);
                          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                          position: relative;
                          overflow: hidden;
                          width: 100%;
                        "
                      >
                        <span style="position: relative; z-index: 1">
                          <i class="fas fa-eye me-2"></i>Tafsilotlarni Ko'rish
                        </span>
                        <!-- Button shine effect -->
                        <div
                          style="
                            position: absolute;
                            top: 0;
                            left: -100%;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(
                              90deg,
                              transparent,
                              rgba(255, 255, 255, 0.3),
                              transparent
                            );
                            transition: left 0.6s;
                          "
                          class="btn-shine"
                        ></div>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %} {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4 text-muted">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              Bu foydalanuvchining buyurtmalari topilmadi
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
      <div
        class="p-4 bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
      >
        <i class="fas fa-user-slash text-muted fa-3x"></i>
      </div>
      <h5 class="text-muted mb-2">Bu kolleksiyada buyurtma yo'q</h5>
      <p class="text-muted mb-3">
        Hali hech kim buyurtma bermagan yoki barcha buyurtmalar bekor qilingan.
      </p>
      <a href="/collections" class="btn btn-primary">
        <i class="fas fa-arrow-left me-2"></i>
        Kolleksiyalarga Qaytish
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Order Details Modal -->
<div
  class="modal fade"
  id="orderDetailsModal"
  tabindex="-1"
  aria-labelledby="orderDetailsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">
          <i class="fas fa-file-lines me-2"></i>
          Buyurtma Tafsilotlari
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Yopish"
        ></button>
      </div>
      <div class="modal-body" id="orderDetailsContent">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yuklanmoqda...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<style>
  /* User card hover effect using theme variables */
  .user-card:hover {
    background-color: var(--primary-50);
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
  }

  /* Enhanced Order card hover effects */
  .order-card {
    position: relative;
    overflow: hidden;
  }

  .order-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.1),
      transparent
    );
    transition: left 0.6s;
    z-index: 1;
  }

  .order-card:hover::before {
    left: 100%;
  }

  .order-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 8px 16px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Image container hover effects */
  .image-container:hover .order-image {
    transform: scale(1.05);
    filter: brightness(1.1) contrast(1.1);
  }

  .image-container:hover .image-overlay {
    opacity: 1;
  }

  .image-container:hover .view-hint {
    opacity: 1;
    transform: translateY(0);
  }

  /* File container hover effect */
  .order-card:hover .mb-3 > div[onclick] {
    transform: scale(1.02);
    border-color: var(--info-400);
  }

  /* Action button hover effects */
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(var(--primary-500-rgb), 0.4);
  }

  .action-btn:hover .btn-shine {
    left: 100%;
  }

  .action-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(var(--primary-500-rgb), 0.3);
  }

  /* Status badge animation */
  .status-badge {
    position: relative;
    overflow: hidden;
  }

  .status-badge::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.5s;
  }

  .order-card:hover .status-badge::before {
    left: 100%;
  }

  /* Pulse animation for active status */
  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.05);
      opacity: 0.8;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .status-badge i[class*="fa-circle"] {
    animation: pulse 2s infinite;
  }

  /* Card entrance animation */
  @keyframes cardSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .order-card {
    animation: cardSlideIn 0.6s ease-out forwards;
  }

  /* Staggered animation delay for cards */
  .order-card:nth-child(1) {
    animation-delay: 0.1s;
  }
  .order-card:nth-child(2) {
    animation-delay: 0.2s;
  }
  .order-card:nth-child(3) {
    animation-delay: 0.3s;
  }
  .order-card:nth-child(4) {
    animation-delay: 0.4s;
  }

  /* Enhanced loading state */
  @keyframes shimmer {
    0% {
      background-position: -200px 0;
    }
    100% {
      background-position: calc(200px + 100%) 0;
    }
  }

  /* Beautiful glow effect for focused cards */
  .order-card:focus-within {
    outline: none;
    box-shadow: 0 0 0 2px var(--primary-200), 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  /* Responsive hover effects - disable on touch devices */
  @media (hover: none) {
    .order-card:hover {
      transform: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .image-container:hover .order-image {
      transform: none;
      filter: brightness(1.02) contrast(1.05);
    }

    .action-btn:hover {
      transform: none;
    }
  }

  /* File thumbnail hover effect */
  .image-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
  }

  /* Button hover effects */
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
    opacity: 0.9;
  }

  /* Theme-aware user list item styling */
  .list-group-item {
    background: var(--bg-secondary);
    border-color: var(--separator);
    transition: var(--transition-fast);
  }

  .list-group-item:hover {
    background: var(--bg-tertiary);
  }

  /* Theme-aware table styling for modal */
  .modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--separator);
    border-radius: var(--radius-lg);
  }

  .modal-header {
    border-bottom: 1px solid var(--separator);
    background: var(--bg-tertiary);
  }

  .modal-title {
    color: var(--text-primary);
  }

  /* User orders expandable sections */
  .user-orders {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .user-orders.show {
    max-height: 2000px;
    transition: max-height 0.5s ease-in;
  }

  /* Enhanced table styling for better theme integration */
  table tr:hover td {
    background-color: var(--bg-tertiary);
  }

  /* Chevron rotation animation */
  .user-card i[id^="icon-"] {
    transition: transform var(--transition-fast);
  }

  .user-card i[id^="icon-"].fa-chevron-up {
    transform: rotate(180deg);
  }
</style>

<script>
  // Enhanced user toggle function with loading state
  function toggleUser(userId) {
    const ordersDiv = document.getElementById("orders-" + userId);
    const icon = document.getElementById("icon-" + userId);
    const text = document.getElementById("text-" + userId);

    if (ordersDiv.classList.contains("show")) {
      // Collapse
      ordersDiv.classList.remove("show");
      icon.classList.remove("fa-chevron-up");
      icon.classList.add("fa-chevron-down");
      if (text) text.textContent = "Ochish uchun bosing";
    } else {
      // Expand
      ordersDiv.classList.add("show");
      icon.classList.remove("fa-chevron-down");
      icon.classList.add("fa-chevron-up");
      if (text) text.textContent = "Yopish uchun bosing";
    }
  }

  // Expand all users
  function expandAllUsers() {
    document.querySelectorAll(".user-orders").forEach((ordersDiv) => {
      ordersDiv.classList.add("show");
    });
    document.querySelectorAll('[id^="icon-"]').forEach((icon) => {
      icon.classList.remove("fa-chevron-down");
      icon.classList.add("fa-chevron-up");
    });
    document.querySelectorAll('[id^="text-"]').forEach((text) => {
      text.textContent = "Yopish uchun bosing";
    });
  }

  // Collapse all users
  function collapseAllUsers() {
    document.querySelectorAll(".user-orders").forEach((ordersDiv) => {
      ordersDiv.classList.remove("show");
    });
    document.querySelectorAll('[id^="icon-"]').forEach((icon) => {
      icon.classList.remove("fa-chevron-up");
      icon.classList.add("fa-chevron-down");
    });
    document.querySelectorAll('[id^="text-"]').forEach((text) => {
      text.textContent = "Ochish uchun bosing";
    });
  }

  // View order details function
  function viewOrderDetails(orderId) {
    const modal = new bootstrap.Modal(
      document.getElementById("orderDetailsModal")
    );
    const modalTitle = document.getElementById("orderDetailsModalLabel");
    const modalContent = document.getElementById("orderDetailsContent");

    modalTitle.innerHTML = `<i class="fas fa-file-lines me-2"></i>Buyurtma #${orderId} Tafsilotlari`;
    modalContent.innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Yuklanmoqda...</span>
        </div>
      </div>
    `;

    modal.show();

    // Fetch order details
    fetch(`/api/orders/${orderId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          modalContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
          return;
        }

        let filesHtml =
          '<p style="color: var(--text-secondary);">Fayllar yo\'q.</p>';
        if (data.files && data.files.length > 0) {
          filesHtml = '<div class="row g-3">';
          data.files.forEach((filePath) => {
            const filename = filePath.split("/").pop().split("\\").pop();
            const fileUrl = `/uploads/${filename}`;
            if (filename.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/)) {
              filesHtml += `
                <div class="col-md-3 col-4">
                  <img src="${fileUrl}" alt="Order Image" class="img-fluid"
                       onclick="showImage('${fileUrl}')"
                       style="cursor: pointer; aspect-ratio: 1; object-fit: cover; border-radius: var(--radius-sm); border: 1px solid var(--separator); box-shadow: var(--shadow-sm); transition: var(--transition-fast);">
                </div>`;
            } else if (filename.toLowerCase().match(/\.(mp4|mov|avi|webm)$/)) {
              filesHtml += `
                <div class="col-md-4 col-6">
                  <video class="img-fluid"
                         style="aspect-ratio: 1; object-fit: cover; border-radius: var(--radius-sm); border: 1px solid var(--separator); box-shadow: var(--shadow-sm);"
                         controls preload="metadata">
                    <source src="${fileUrl}" type="video/mp4">
                    Videoni ko'rsatib bo'lmadi.
                  </video>
                </div>`;
            }
          });
          filesHtml += "</div>";
        }

        modalContent.innerHTML = `
          <div class="row g-3">
            <div class="col-md-6">
              <h5 style="color: var(--text-primary); margin-bottom: var(--spacing-md);"><i class="fas fa-user me-2"></i>Foydalanuvchi</h5>
              <div style="background: var(--bg-secondary); border: 1px solid var(--separator); border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
                <div style="padding: var(--spacing-md);">
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid var(--separator);"><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary); width: 35%;"><strong>Ism:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">${
                      data.name || "N/A"
                    } ${data.surname || ""}</td></tr>
                    <tr style="border-bottom: 1px solid var(--separator);"><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary);"><strong>Telefon:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">${
                      data.phone || "N/A"
                    }</td></tr>
                    <tr style="border-bottom: 1px solid var(--separator);"><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary);"><strong>Username:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">@${
                      data.username || "N/A"
                    }</td></tr>
                    <tr><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary);"><strong>Kod:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">${
                      data.code || "N/A"
                    }</td></tr>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h5 style="color: var(--text-primary); margin-bottom: var(--spacing-md);"><i class="fas fa-box me-2"></i>Buyurtma</h5>
              <div style="background: var(--bg-secondary); border: 1px solid var(--separator); border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
                <div style="padding: var(--spacing-md);">
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid var(--separator);"><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary); width: 35%;"><strong>ID:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">#${
                      data.id
                    }</td></tr>
                    <tr style="border-bottom: 1px solid var(--separator);"><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary);"><strong>Kolleksiya:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">#${
                      data.collection_id
                    }</td></tr>
                    <tr style="border-bottom: 1px solid var(--separator);"><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary);"><strong>Seriya:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">${
                      data.amount || "N/A"
                    }</td></tr>
                    <tr><td style="padding: var(--spacing-xs) 0; font-weight: 600; color: var(--text-secondary);"><strong>Yaratilgan:</strong></td><td style="padding: var(--spacing-xs) 0; color: var(--text-primary);">${new Date(
                      data.created_at
                    ).toLocaleString("uz-UZ")}</td></tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <hr style="border-color: var(--separator); margin: var(--spacing-lg) 0;">
          <h5 style="color: var(--text-primary); margin-bottom: var(--spacing-md);"><i class="fas fa-images me-2"></i>Fayllar (${
            data.files ? data.files.length : 0
          } ta)</h5>
          ${filesHtml}
        `;
      })
      .catch((error) => {
        console.error("Error fetching order details:", error);
        modalContent.innerHTML = `<div class="alert alert-danger">Tafsilotlarni yuklashda xatolik yuz berdi.</div>`;
      });
  }

  // Set active navigation
  document.addEventListener("DOMContentLoaded", function () {
    // Mark collections nav as active
    const collectionsNav = document.querySelector('a[href="/collections"]');
    if (collectionsNav) {
      collectionsNav.classList.add("active");
    }
  });
</script>
{% endblock %}
