{% extends "base.html" %} {% block title %}Admin Panel - Sozlamalar{% endblock
%} {% block content %}

<style>
  .admin-main {
    padding: var(--spacing-xl) var(--spacing-lg);
    background: var(--bg-primary);
    max-width: 1200px;
    margin: 0 auto;
  }

  .admin-section {
    background: var(--bg-secondary);
    border: 1px solid var(--separator);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .admin-section-header {
    padding: var(--spacing-lg);
    background: linear-gradient(
      135deg,
      var(--bg-tertiary),
      var(--bg-quaternary)
    );
    border-bottom: 1px solid var(--separator);
  }

  .admin-section-content {
    padding: var(--spacing-xl);
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-lg);
  }

  /* Mobile responsive styles */
  @media (max-width: 768px) {
    .admin-main {
      padding: var(--spacing-lg) var(--spacing-md);
    }

    .settings-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
    }

    /* Mobile page header optimizations */
    .card .card-body h4 {
      font-size: 1.25rem;
    }

    .card .card-body p.small {
      font-size: 0.75rem;
    }

    /* Form elements mobile optimization */
    .form-floating {
      margin-bottom: var(--spacing-md);
    }

    .form-control, .form-select {
      font-size: 0.9rem;
    }

    /* Userbot 2x2 grid mobile stacking */
    .row.mb-3 .col-md-6,
    .row .col-md-6 {
      margin-bottom: var(--spacing-sm);
    }

    /* Button optimizations */
    .btn-lg {
      font-size: 1rem;
      padding: 0.75rem 1rem;
    }

    .admin-section-content {
      padding: var(--spacing-lg);
    }
  }

  /* Extra small mobile styles */
  @media (max-width: 480px) {
    .admin-main {
      padding: var(--spacing-md) var(--spacing-sm);
    }

    .admin-section-content {
      padding: var(--spacing-md);
    }
  }

  .form-floating {
    margin-bottom: var(--spacing-lg);
  }
</style>

{% if not current_user %}
<div
  class="row justify-content-center align-items-center"
  style="min-height: 70vh"
>
  <div class="col-md-6 col-lg-4">
    <div class="card">
      <div class="card-body p-4">
        <h3 class="card-title text-center mb-4">
          <i class="fas fa-shield-alt me-2 text-primary"></i>
          Admin Kirish
        </h3>
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        <form action="/auth/login" method="post">
          <div class="mb-3">
            <label for="username" class="form-label">Foydalanuvchi nomi</label>
            <input
              type="text"
              class="form-control"
              id="username"
              name="username"
              required
            />
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Parol</label>
            <input
              type="password"
              class="form-control"
              id="password"
              name="password"
              required
            />
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-sign-in-alt me-2"></i>
              Kirish
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% else %}

<!-- Admin Content -->
<main class="admin-main">
    <!-- Page Header -->
    <div class="card mb-4">
      <div class="card-body p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <div class="p-2 bg-primary rounded">
              <i class="fas fa-user-shield text-white fs-5"></i>
            </div>
            <div>
              <h4 class="mb-0 fw-semibold">Admin Boshqaruv Paneli</h4>
              <p class="text-muted mb-0 small d-none d-md-block">
                Tizim sozlamalari va boshqaruv
              </p>
            </div>
          </div>
          <div class="d-flex gap-2">
            <a href="/" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-arrow-left me-1"></i>
              <span class="d-none d-md-inline">Asosiy Panel</span>
              <span class="d-md-none">Asosiy</span>
            </a>
            <a href="/auth/logout" class="btn btn-outline-danger btn-sm">
              <i class="fas fa-sign-out-alt me-1"></i>
              <span class="d-none d-md-inline">Chiqish</span>
              <span class="d-md-none">Exit</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(request) %} {% if messages %} {% for
    msg in messages %}
    <div
      class="alert alert-{{ msg.category }} alert-dismissible fade show mb-4"
      role="alert"
    >
      {{ msg.message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% endfor %} {% endif %} {% endwith %}

    <!-- Admin Settings -->
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="d-flex align-items-center gap-3">
          <div class="p-2 rounded-3" style="background: var(--primary)">
            <i class="fas fa-cogs text-white"></i>
          </div>
          <div>
            <h5 class="mb-0 fw-bold">Umumiy Sozlamalar</h5>
            <small class="text-muted"
              >Tizim asosiy konfiguratsiyalari</small
            >
          </div>
        </div>
      </div>

      <div class="admin-section-content">
            <form action="/settings" method="post">
              <!-- Userbot Settings Section -->
              <div class="mb-5">
                <h6 class="fw-bold text-primary mb-3">
                  <i class="fas fa-robot me-2"></i>Userbot Sozlamalari
                </h6>
                <!-- Status -->
                <div class="card mb-3">
                  <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
                    <div class="mb-2 mb-md-0">
                      {% if userbot_status and userbot_status.authorized %}
                        <span class="badge bg-success">Ulangan</span>
                        {% if userbot_status.me and userbot_status.me.name %}
                          <span class="ms-2">{{ userbot_status.me.name }}</span>
                        {% endif %}
                      {% elif userbot_status and userbot_status.connected %}
                        <span class="badge bg-warning text-dark">Ulanmoqda</span>
                      {% else %}
                        <span class="badge bg-secondary">Ulanmagan</span>
                      {% endif %}
                    </div>
                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-outline-danger btn-sm" form="userbot-logout-form" formnovalidate>
                        <i class="fas fa-power-off me-1"></i> Logout (Revoke & Delete Session)
                      </button>
                    </div>
                  </div>
                </div>

                <!-- First Row: Phone + Password -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="userbot_phone_number"
                        name="userbot_phone_number"
                        placeholder="Telefon raqami"
                        value="{{ settings.userbot_phone_number }}"
                      />
                      <label for="userbot_phone_number">
                        <i class="fas fa-phone me-1"></i>Telefon Raqami
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="password"
                        class="form-control"
                        id="userbot_password"
                        name="userbot_password"
                        placeholder="Parol"
                        value="{{ settings.userbot_password }}"
                      />
                      <label for="userbot_password">
                        <i class="fas fa-key me-1"></i>Parol
                      </label>
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-2 mt-3 align-items-center">
                  <button type="submit" class="btn btn-outline-primary" form="userbot-login-form" formnovalidate>
                    <i class="fas fa-sms me-1"></i> Send Code
                  </button>
                  <div class="input-group" style="max-width: 360px;">
                    <input type="text" class="form-control" name="code" placeholder="Tasdiqlash kodi" form="userbot-code-form" />
                    <button type="submit" class="btn btn-primary" form="userbot-code-form" formnovalidate>
                      <i class="fas fa-check me-1"></i> Confirm
                    </button>
                  </div>
                </div>
              </div>

              <!-- Channel & Group Settings -->
              <div class="mb-5">
                <h6 class="fw-bold text-success mb-3">
                  <i class="fas fa-comments me-2"></i>Kanal va Guruh Sozlamalari
                </h6>
                <div class="settings-grid">
                  <div class="form-floating">
                    <input
                      type="text"
                      class="form-control"
                      id="private_channel_id"
                      name="private_channel_id"
                      placeholder="Channel ID"
                      value="{{ settings.private_channel_id }}"
                    />
                    <label for="private_channel_id">
                      <i class="fas fa-broadcast-tower me-1"></i>Maxfiy Kanal ID
                    </label>
                  </div>

                  <div class="form-floating">
                    <input
                      type="text"
                      class="form-control"
                      id="group_id"
                      name="group_id"
                      placeholder="Group ID"
                      value="{{ settings.group_id }}"
                    />
                    <label for="group_id">
                      <i class="fas fa-users me-1"></i>Guruh ID
                    </label>
                  </div>
                </div>
              </div>

              <!-- Admin & AI Settings -->
              <div class="mb-5">
                <h6 class="fw-bold text-warning mb-3">
                  <i class="fas fa-brain me-2"></i>Admin va AI Sozlamalari
                </h6>
                <div class="settings-grid">

                  <div class="form-floating">
                    <select
                      class="form-select"
                      id="default_ai_model"
                      name="default_ai_model"
                    >
                      <option value="gemini-2.5-flash-lite" 
                        {% if settings.default_ai_model == 'gemini-2.5-flash-lite' %}selected{% endif %}>
                        Gemini 2.5 Flash Lite
                      </option>
                      <option value="gemini-2.0-flash"
                        {% if settings.default_ai_model == 'gemini-2.0-flash' %}selected{% endif %}>
                        Gemini 2.0 Flash
                      </option>
                    </select>
                    <label for="default_ai_model">
                      <i class="fas fa-microchip me-1"></i>Standart AI Modeli
                    </label>
                  </div>
                </div>
              </div>

              <!-- Topic ID Settings -->
              <div class="mb-5">
                <h6 class="fw-bold text-secondary mb-3">
                  <i class="fas fa-hashtag me-2"></i>Topic ID Sozlamalari
                </h6>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="ai_confirmations_topic_id"
                        name="ai_confirmations_topic_id"
                        placeholder="AI Confirmations Topic ID"
                        value="{{ settings.ai_confirmations_topic_id }}"
                      />
                      <label for="ai_confirmations_topic_id">
                        <i class="fas fa-robot me-1"></i>AI Confirmations Topic ID
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="confirmation_topic_id"
                        name="confirmation_topic_id"
                        placeholder="Confirmations Topic ID"
                        value="{{ settings.confirmation_topic_id }}"
                      />
                      <label for="confirmation_topic_id">
                        <i class="fas fa-clipboard-check me-1"></i>Confirmations Topic ID
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="realtime_orders_topic_id"
                        name="realtime_orders_topic_id"
                        placeholder="Realtime Orders Topic ID"
                        value="{{ settings.realtime_orders_topic_id }}"
                      />
                      <label for="realtime_orders_topic_id">
                        <i class="fas fa-bolt me-1"></i>Realtime Orders Topic ID
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        id="find_orders_topic_id"
                        name="find_orders_topic_id"
                        placeholder="Find Orders Topic ID"
                        value="{{ settings.find_orders_topic_id }}"
                      />
                      <label for="find_orders_topic_id">
                        <i class="fas fa-search me-1"></i>Find Orders Topic ID
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Obuna sozlamalari webdan olib tashlandi; bot orqali boshqariladi -->

        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary btn-lg px-4">
            <i class="fas fa-save me-2"></i>Sozlamalarni Saqlash
          </button>
        </div>
      </form>
      <!-- Detached forms for userbot actions to avoid nested forms -->
      <form id="userbot-logout-form" action="/userbot/logout" method="post"></form>
      <form id="userbot-login-form" action="/userbot/login" method="post">
        <input type="hidden" name="userbot_phone_number" value="{{ settings.userbot_phone_number }}" />
        <input type="hidden" name="userbot_password" value="{{ settings.userbot_password }}" />
      </form>
      <form id="userbot-code-form" action="/userbot/submit-code" method="post"></form>
    </div>
  </div>
</main>


{% endif %} {% endblock %}
